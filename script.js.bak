// åŸºç¡€åŠŸèƒ½ï¼šæ—¶é’Ÿã€é—®å€™ã€æœç´¢ã€å¿«é€Ÿé“¾æ¥ç®¡ç†ã€ä¸»é¢˜åˆ‡æ¢ã€localStorage æŒä¹…åŒ–

// ==================== IndexedDB å­˜å‚¨ç®¡ç† ====================
// ç”¨äºå­˜å‚¨å¤§æ–‡ä»¶ï¼ˆå¦‚è§†é¢‘èƒŒæ™¯ï¼‰
const DB_NAME = 'StartPageDB';
const DB_VERSION = 1;
const STORE_NAME = 'backgrounds';

let db = null;

// åˆå§‹åŒ–IndexedDB
function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
            console.error('IndexedDBæ‰“å¼€å¤±è´¥:', request.error);
            reject(request.error);
        };
        
        request.onsuccess = () => {
            db = request.result;
            console.log('IndexedDBå·²å°±ç»ª');
            resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                objectStore.createIndex('type', 'type', { unique: false });
                console.log('IndexedDBå¯¹è±¡ä»“åº“å·²åˆ›å»º');
            }
        };
    });
}

// ä¿å­˜èƒŒæ™¯åˆ°IndexedDB
function saveBackgroundToDB(bgData, bgType) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject(new Error('IndexedDBæœªåˆå§‹åŒ–'));
            return;
        }
        
        // æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡è¯»å–æœ€æ–°æ•°æ®
        clearBackgroundCache();
        
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(STORE_NAME);
        
        const data = {
            id: 'current_background',
            data: bgData,
            type: bgType,
            timestamp: Date.now()
        };
        
        const request = objectStore.put(data);
        
        request.onsuccess = () => {
            console.log('èƒŒæ™¯å·²ä¿å­˜åˆ°IndexedDB');
            resolve();
        };
        
        request.onerror = () => {
            console.error('ä¿å­˜åˆ°IndexedDBå¤±è´¥:', request.error);
            reject(request.error);
        };
    });
}

// èƒŒæ™¯æ•°æ®ç¼“å­˜ï¼ˆé¿å…é‡å¤ä»IndexedDBè¯»å–ï¼‰
let backgroundCache = null;
let backgroundCacheTime = 0;
const CACHE_DURATION = 60 * 60 * 1000; // ç¼“å­˜1å°æ—¶ï¼ˆæ›´é•¿æ—¶é—´ï¼‰

// ä»IndexedDBåŠ è½½èƒŒæ™¯ï¼ˆå¸¦ç¼“å­˜ï¼‰
function loadBackgroundFromDB() {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥ç¼“å­˜
        const now = Date.now();
        if (backgroundCache && (now - backgroundCacheTime) < CACHE_DURATION) {
            console.log('ä½¿ç”¨ç¼“å­˜çš„èƒŒæ™¯æ•°æ®');
            resolve(backgroundCache);
            return;
        }
        
        if (!db) {
            reject(new Error('IndexedDBæœªåˆå§‹åŒ–'));
            return;
        }
        
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.get('current_background');
        
        request.onsuccess = () => {
            if (request.result) {
                // æ›´æ–°ç¼“å­˜
                backgroundCache = request.result;
                backgroundCacheTime = now;
                console.log('ä»IndexedDBåŠ è½½èƒŒæ™¯æˆåŠŸå¹¶ç¼“å­˜');
                resolve(request.result);
            } else {
                resolve(null);
            }
        };
        
        request.onerror = () => {
            console.error('ä»IndexedDBåŠ è½½å¤±è´¥:', request.error);
            reject(request.error);
        };
    });
}

// æ¸…é™¤èƒŒæ™¯ç¼“å­˜
function clearBackgroundCache() {
    backgroundCache = null;
    backgroundCacheTime = 0;
}

// åˆ é™¤IndexedDBä¸­çš„èƒŒæ™¯
function deleteBackgroundFromDB() {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject(new Error('IndexedDBæœªåˆå§‹åŒ–'));
            return;
        }
        
        // æ¸…é™¤ç¼“å­˜
        clearBackgroundCache();
        
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.delete('current_background');
        
        request.onsuccess = () => {
            console.log('IndexedDBä¸­çš„èƒŒæ™¯å·²åˆ é™¤');
            resolve();
        };
        
        request.onerror = () => {
            console.error('åˆ é™¤IndexedDBæ•°æ®å¤±è´¥:', request.error);
            reject(request.error);
        };
    });
}

// ==================== é»˜è®¤æ•°æ® ====================

const defaultLinks = [
  {title: 'GitHub', url: 'https://github.com'},
  {title: 'Gmail', url: 'https://mail.google.com'},
  {title: 'çŸ¥ä¹', url: 'https://www.zhihu.com'},
  {title: 'æ˜é‡‘', url: 'https://juejin.cn'}
];

// é»˜è®¤æœç´¢å¼•æ“åˆ—è¡¨
const defaultEngines = [
  { name: 'Google', url: 'https://www.google.com/search?q=' },
  { name: 'Bing', url: 'https://www.bing.com/search?q=' },
  { name: 'ç™¾åº¦', url: 'https://www.baidu.com/s?wd=' },
  { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=' }
];

// æœç´¢å¼•æ“ç®¡ç†
let searchEngines = [];

function loadSearchEngines() {
  try {
    const saved = localStorage.getItem('startpage.searchEngines');
    if (saved) {
      searchEngines = JSON.parse(saved);
    } else {
      searchEngines = JSON.parse(JSON.stringify(defaultEngines));
      saveSearchEngines();
    }
    syncEngineSelect();
  } catch (e) {
    console.error('åŠ è½½æœç´¢å¼•æ“å¤±è´¥:', e);
    searchEngines = JSON.parse(JSON.stringify(defaultEngines));
  }
}

function saveSearchEngines() {
  try {
    localStorage.setItem('startpage.searchEngines', JSON.stringify(searchEngines));
  } catch (e) {
    console.error('ä¿å­˜æœç´¢å¼•æ“å¤±è´¥:', e);
  }
}

function syncEngineSelect() {
  const select = document.getElementById('engineSelect');
  if (!select) return;
  
  // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
  const currentValue = select.value;
  
  // æ¸…ç©º select
  select.innerHTML = '';
  
  // é‡æ–°å¡«å…… select
  searchEngines.forEach(engine => {
    const option = document.createElement('option');
    option.value = engine.url;
    option.textContent = engine.name;
    select.appendChild(option);
  });
  
  // æ¢å¤é€‰ä¸­å€¼ï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
  if (select.querySelector(`option[value="${currentValue}"]`)) {
    select.value = currentValue;
  } else if (searchEngines.length > 0) {
    select.value = searchEngines[0].url;
  }
}

// æœ¬åœ°è¯­å½•åº“ï¼ˆå½“APIå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
const localQuotes = [
  { text: 'æˆåŠŸçš„ç§˜å¯†åœ¨äºå§‹ç»ˆå¦‚ä¸€åœ°å¿ äºç›®æ ‡', author: 'å¯Œå…°å…‹æ—' },
];

// æ€§èƒ½ä¼˜åŒ–ï¼šé˜²æŠ–å‡½æ•°
function debounce(func, delay = 300) {
  let timeoutId;
  return function(...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func(...args), delay);
  };
}

// æ€§èƒ½ä¼˜åŒ–ï¼šèŠ‚æµå‡½æ•°
function throttle(func, limit = 300) {
  let lastCall = 0;
  return function(...args) {
    const now = Date.now();
    if (now - lastCall >= limit) {
      lastCall = now;
      func(...args);
    }
  };
}

// æ€§èƒ½ä¼˜åŒ–ï¼šDOM å…ƒç´ ç¼“å­˜
const domCache = {};
function getCachedElement(selector) {
  if (!domCache[selector]) {
    domCache[selector] = document.querySelector(selector);
  }
  return domCache[selector];
}

// state
let links = [];

// é»˜è®¤ä¹¦ç­¾æ•°æ®
const defaultBookmarks = [
  {
    "id": 1764336893197.6904,
    "title": "æ·±åœ³æŠ€æœ¯å¤§å­¦OAç³»ç»Ÿ",
    "url": "https://home.sztu.edu.cn/bmportal/index.portal",
    "folder": "imported",
    "favicon": "https://www.google.com/s2/favicons?domain=home.sztu.edu.cn&sz=64",
    "visible": true,
    "showLogo": false,
    "timestamp": 1764336893197
  },
  {
    "id": 1764336893197.658,
    "title": "æ•°æ®ç»“æ„è¯¾ç¨‹ç»„",
    "url": "https://acm-sztu-edu-cn-40080-p.webvpn.sztu.edu.cn:8118/course/index",
    "folder": "imported",
    "favicon": "https://www.google.com/s2/favicons?domain=acm-sztu-edu-cn-40080-p.webvpn.sztu.edu.cn&sz=64",
    "visible": true,
    "showLogo": false,
    "timestamp": 1764336893197
  },
  {
    "id": 1764336893197.5527,
    "title": "æ·±åœ³æŠ€æœ¯å¤§å­¦ä¿¡æ¯ä¸­å¿ƒå…¬æ–‡é€š",
    "url": "https://nbw.sztu.edu.cn/",
    "folder": "imported",
    "favicon": "https://www.google.com/s2/favicons?domain=nbw.sztu.edu.cn&sz=64",
    "visible": true,
    "showLogo": false,
    "timestamp": 1764336893197
  },
  {
    "id": 1764336893197.1243,
    "title": "æ•™åŠ¡ç³»ç»Ÿ",
    "url": "https://auth.sztu.edu.cn/idp/authcenter/ActionAuthChain?entityId=jiaowu",
    "folder": "imported",
    "favicon": "https://www.google.com/s2/favicons?domain=auth.sztu.edu.cn&sz=64",
    "visible": true,
    "showLogo": false,
    "timestamp": 1764336893197
  },
  {
    "id": 1764336893197.946,
    "title": "è±†åŒ…",
    "url": "https://www.doubao.com/chat/",
    "folder": "imported",
    "favicon": "https://www.google.com/s2/favicons?domain=www.doubao.com&sz=64",
    "visible": true,
    "showLogo": true,
    "timestamp": 1764336893197
  }
];

// æ”¶è—å¤¹ç®¡ç†
let bookmarks = JSON.parse(localStorage.getItem('startpage.bookmarks') || '[]');

// å¦‚æœä¹¦ç­¾ä¸ºç©ºï¼ŒåŠ è½½é»˜è®¤ä¹¦ç­¾
if (bookmarks.length === 0) {
  bookmarks = JSON.parse(JSON.stringify(defaultBookmarks));
  localStorage.setItem('startpage.bookmarks', JSON.stringify(bookmarks));
}

// è¿ç§»ï¼šç¡®ä¿æ‰€æœ‰ä¹¦ç­¾éƒ½æœ‰ visible å’Œ showLogo å­—æ®µ
bookmarks = bookmarks.map(b => ({ 
  ...b, 
  visible: b.visible !== false ? true : false,
  showLogo: b.showLogo !== false ? true : false
}));

// æ¡Œé¢ä¹¦ç­¾å¼€å…³
let bookmarksEnabled = localStorage.getItem('startpage.bookmarksEnabled') === 'true';

// helpers
function $(s){return document.querySelector(s)}
function saveState(){localStorage.setItem('startpage.links', JSON.stringify(links));}
function loadState(){
  const raw = localStorage.getItem('startpage.links');
  if(raw){
    try{ links = JSON.parse(raw); }catch(e){ links = defaultLinks; }
  }else links = defaultLinks;
}

// å®ç”¨å·¥å…·å‡½æ•°
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// clock & greeting
function updateClock(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  $('#clock').textContent = `${hh}:${mm}`;
  const h = now.getHours();
  let g = 'ä½ å¥½';
  if(h < 6) g = 'å¤œæ·±äº†ï¼Œæ—©ç‚¹ä¼‘æ¯';
  else if(h < 12) g = 'æ—©ä¸Šå¥½';
  else if(h < 18) g = 'ä¸‹åˆå¥½';
  else g = 'æ™šä¸Šå¥½';
  $('#greeting').textContent = g;
}

// æ¯æ—¥ä¸€è¨€åŠŸèƒ½
async function loadQuote() {
  const quoteText = $('#quoteText');
  const quoteAuthor = $('#quoteAuthor');

  try {
    // ä½¿ç”¨ nxvav ä¸€è¨€APIï¼Œæ·»åŠ è¶…æ—¶æ§åˆ¶
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶
    
    const response = await fetch('https://api.nxvav.cn/api/yiyan/?encode=json&charset=utf-8', {
      method: 'GET',
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    // nxvav API è¿”å›æ ¼å¼: { id: number, yiyan: "...", nick: "...", createTime: number }
    if (result && result.yiyan) {
      quoteText.textContent = `"${result.yiyan}"`;
      // æ˜¾ç¤ºä½œè€…æ˜µç§°
      const authorText = result.nick || 'ä½šå';
      quoteAuthor.textContent = authorText;
      return; // æˆåŠŸåŠ è½½ï¼Œé€€å‡ºå‡½æ•°
    } else {
      console.warn('ä¸€è¨€APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸:', result);
      throw new Error('APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
    }
  } catch (error) {
    // APIå¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°è¯­å½•
    if (error.name === 'AbortError') {
      console.warn('ä¸€è¨€APIè¯·æ±‚è¶…æ—¶ï¼Œä½¿ç”¨æœ¬åœ°è¯­å½•');
    } else {
      console.warn('ä¸€è¨€APIåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è¯­å½•:', error.message);
    }
    
    const randomQuote = localQuotes[Math.floor(Math.random() * localQuotes.length)];
    quoteText.textContent = `"${randomQuote.text}"`;
    quoteAuthor.textContent = randomQuote.author;
  }
}

// å¤©æ°”åŠŸèƒ½
let weatherData = null; // å­˜å‚¨å®Œæ•´å¤©æ°”æ•°æ®

// è·å–åœ°ç†ä½ç½®åç§°
async function getLocationName(latitude, longitude) {
  try {
    // ä½¿ç”¨å…è´¹çš„Nominatimé€†åœ°ç†ç¼–ç API
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&accept-language=zh-CN`,
      {
        headers: {
          'User-Agent': 'StartPage/1.0'
        }
      }
    );
    
    if (response.ok) {
      const data = await response.json();
      const address = data.address;
      
      // ä¼˜å…ˆè¿”å›ï¼šåŸå¸‚ > å¿ > å· > çœ
      const location = address.city || 
                      address.county || 
                      address.state || 
                      address.province || 
                      address.country || 
                      'æœªçŸ¥ä½ç½®';
      
      return location;
    }
  } catch (error) {
    console.warn('è·å–ä½ç½®åç§°å¤±è´¥:', error);
  }
  
  return 'å½“å‰ä½ç½®';
}

async function loadWeather() {
  const weatherIcon = $('#weatherIcon');
  const weatherTemp = $('#weatherTemp');
  
  try {
    // è·å–ç”¨æˆ·ä½ç½®
    const position = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        timeout: 10000,
        maximumAge: 600000 // 10åˆ†é’Ÿç¼“å­˜
      });
    });
    
    const { latitude, longitude } = position.coords;
    
    // è·å–åœ°ç‚¹åç§°
    const locationName = await getLocationName(latitude, longitude);
    
    // ä½¿ç”¨å…è´¹çš„Open-Meteo APIï¼ˆæ— éœ€å¯†é’¥ï¼‰è·å–å®Œæ•´å¤©æ°”æ•°æ®
    const response = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,wind_direction_10m&daily=uv_index_max,sunrise,sunset&timezone=auto`
    );
    
    if (response.ok) {
      const data = await response.json();
      const current = data.current;
      const daily = data.daily;
      const temp = Math.round(current.temperature_2m);
      const weatherCode = current.weather_code;
      
      // æ ¹æ®å¤©æ°”ä»£ç è®¾ç½®å›¾æ ‡
      const weatherIcons = {
        0: 'â˜€ï¸',    // æ™´å¤©
        1: 'ğŸŒ¤ï¸',   // ä¸»è¦æ™´æœ—
        2: 'â›…',   // éƒ¨åˆ†å¤šäº‘
        3: 'â˜ï¸',   // é˜´å¤©
        45: 'ğŸŒ«ï¸',  // é›¾
        48: 'ğŸŒ«ï¸',  // é›¾å‡‡
        51: 'ğŸŒ¦ï¸',  // å°é›¨
        53: 'ğŸŒ§ï¸',  // ä¸­é›¨
        55: 'ğŸŒ§ï¸',  // å¤§é›¨
        61: 'ğŸŒ¦ï¸',  // å°é›¨
        63: 'ğŸŒ§ï¸',  // ä¸­é›¨
        65: 'ğŸŒ§ï¸',  // å¤§é›¨
        71: 'ğŸŒ¨ï¸',  // å°é›ª
        73: 'ğŸŒ¨ï¸',  // ä¸­é›ª
        75: 'ğŸŒ¨ï¸',  // å¤§é›ª
        77: 'â„ï¸',   // é›ªç²’
        80: 'ğŸŒ¦ï¸',  // é˜µé›¨
        81: 'â›ˆï¸',   // é›·é˜µé›¨
        82: 'â›ˆï¸',   // å¼ºé›·é˜µé›¨
        85: 'ğŸŒ¨ï¸',  // é˜µé›ª
        86: 'ğŸŒ¨ï¸',  // å¤§é˜µé›ª
        95: 'â›ˆï¸',   // é›·æš´
        96: 'â›ˆï¸',   // é›·æš´ä¼´å†°é›¹
        99: 'â›ˆï¸'    // å¼ºé›·æš´ä¼´å†°é›¹
      };
      
      const weatherDescriptions = {
        0: 'æ™´æœ—', 1: 'æ™´æœ—', 2: 'å¤šäº‘', 3: 'é˜´å¤©',
        45: 'æœ‰é›¾', 48: 'æœ‰é›¾', 51: 'å°é›¨', 53: 'ä¸­é›¨', 55: 'å¤§é›¨',
        61: 'å°é›¨', 63: 'ä¸­é›¨', 65: 'å¤§é›¨', 71: 'å°é›ª', 73: 'ä¸­é›ª', 75: 'å¤§é›ª',
        77: 'é›¨å¤¹é›ª', 80: 'é˜µé›¨', 81: 'é›·é˜µé›¨', 82: 'å¼ºé›·é˜µé›¨',
        85: 'é˜µé›ª', 86: 'å¤§é˜µé›ª', 95: 'é›·æš´', 96: 'å†°é›¹', 99: 'å¼ºå†°é›¹'
      };
      
      // é£å‘è½¬æ¢
      const getWindDirection = (degree) => {
        const directions = ['åŒ—', 'ä¸œåŒ—', 'ä¸œ', 'ä¸œå—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
        const index = Math.round(degree / 45) % 8;
        return directions[index];
      };
      
      // ç´«å¤–çº¿ç­‰çº§
      const getUVLevel = (uvIndex) => {
        if (uvIndex <= 2) return 'ä½';
        if (uvIndex <= 5) return 'ä¸­ç­‰';
        if (uvIndex <= 7) return 'é«˜';
        if (uvIndex <= 10) return 'å¾ˆé«˜';
        return 'æé«˜';
      };
      
      // æ ¼å¼åŒ–æ—¶é—´
      const formatTime = (isoString) => {
        if (!isoString) return '--:--';
        const date = new Date(isoString);
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      };
      
      // å­˜å‚¨å®Œæ•´å¤©æ°”æ•°æ®
      weatherData = {
        location: locationName,
        temp,
        icon: weatherIcons[weatherCode] || 'ğŸŒ¤ï¸',
        description: weatherDescriptions[weatherCode] || 'æœªçŸ¥',
        humidity: current.relative_humidity_2m,
        feelsLike: Math.round(current.apparent_temperature),
        windSpeed: Math.round(current.wind_speed_10m),
        windDirection: getWindDirection(current.wind_direction_10m),
        uvIndex: daily.uv_index_max[0],
        uvLevel: getUVLevel(daily.uv_index_max[0]),
        sunrise: formatTime(daily.sunrise[0]),
        sunset: formatTime(daily.sunset[0]),
        visibility: 10, // Open-Meteoä¸æä¾›èƒ½è§åº¦ï¼Œä½¿ç”¨é»˜è®¤å€¼
        updateTime: new Date().toLocaleString('zh-CN', { 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit' 
        })
      };
      
      // æ›´æ–°topbaræ˜¾ç¤º
      weatherIcon.textContent = weatherData.icon;
      weatherTemp.textContent = `${temp}Â°C`;
      
      // ä¿å­˜åˆ°localStorageä¾›ä¸‹æ¬¡ä½¿ç”¨
      localStorage.setItem('startpage.weather', JSON.stringify({
        ...weatherData,
        timestamp: Date.now()
      }));
    }
  } catch (error) {
    console.warn('å¤©æ°”æ•°æ®åŠ è½½å¤±è´¥:', error);
    // å¦‚æœè·å–å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½ç¼“å­˜
    const cached = localStorage.getItem('startpage.weather');
    if (cached) {
      try {
        const data = JSON.parse(cached);
        // å¦‚æœç¼“å­˜ä¸è¶…è¿‡1å°æ—¶ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®
        if (Date.now() - data.timestamp < 3600000) {
          weatherData = data;
          weatherIcon.textContent = data.icon;
          weatherTemp.textContent = `${data.temp}Â°C`;
          return;
        }
      } catch (e) {}
    }
    
    // å®Œå…¨å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å€¼
    weatherIcon.textContent = 'ğŸŒ¤ï¸';
    weatherTemp.textContent = '--Â°C';
  }
}

// æ˜¾ç¤ºå¤©æ°”è¯¦æƒ…å¡ç‰‡
function showWeatherCard() {
  if (!weatherData) {
    showToast('å¤©æ°”æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
    return;
  }
  
  // æ›´æ–°å¡ç‰‡å†…å®¹
  $('#weatherLocation').textContent = weatherData.location || 'å¤©æ°”è¯¦æƒ…';
  $('#weatherCardIcon').textContent = weatherData.icon;
  $('#weatherCardTemp').textContent = `${weatherData.temp}Â°C`;
  $('#weatherCardDesc').textContent = weatherData.description;
  $('#weatherWindSpeed').textContent = `${weatherData.windSpeed} km/h`;
  $('#weatherHumidity').textContent = `${weatherData.humidity}%`;
  $('#weatherFeelsLike').textContent = `${weatherData.feelsLike}Â°C`;
  $('#weatherVisibility').textContent = `${weatherData.visibility} km`;
  $('#weatherUV').textContent = `${weatherData.uvIndex} (${weatherData.uvLevel})`;
  $('#weatherSunrise').textContent = weatherData.sunrise;
  $('#weatherSunset').textContent = weatherData.sunset;
  $('#weatherWindDir').textContent = weatherData.windDirection;
  $('#weatherUpdateTime').textContent = `æ›´æ–°æ—¶é—´ï¼š${weatherData.updateTime}`;
  
  // æ˜¾ç¤ºå¡ç‰‡å’Œé®ç½©
  $('#weatherCard').classList.remove('hidden');
  $('#weatherOverlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

// å…³é—­å¤©æ°”è¯¦æƒ…å¡ç‰‡
function closeWeatherCard() {
  $('#weatherCard').classList.add('hidden');
  $('#weatherOverlay').classList.add('hidden');
  document.body.style.overflow = '';
}

// render links
// è·å–ç½‘ç«™faviconçš„å‡½æ•°  
function getFaviconUrl(url) {
  try {
    const domain = new URL(url).origin;
    return `${domain}/favicon.ico`;
  } catch {
    return null;
  }
}

// è·å–é«˜è´¨é‡Logoçš„å¤‡é€‰æ–¹æ¡ˆ
function getLogoSources(url) {
  try {
    const urlObj = new URL(url);
    const domain = urlObj.origin;
    const hostname = urlObj.hostname;
    
    return [
      `${domain}/favicon.ico`,
      `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`,
      `https://favicon.yandex.net/favicon/${hostname}`,
      `${domain}/apple-touch-icon.png`,
      `${domain}/favicon.png`
    ];
  } catch {
    return [];
  }
}

function renderLinks(){
  const container = $('#linksGrid');
    container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨ä»¥å‡†å¤‡æ¸²æŸ“æ–°é“¾æ¥
  links.forEach((l,idx)=>{
    const a = document.createElement('a');
    a.className = 'link-card';
    a.href = l.url;
    a.target = '_blank';
    
    // åˆ›å»ºfaviconå…ƒç´ 
    const faviconDiv = document.createElement('div');
    faviconDiv.className = 'favicon';
    
    // è·å–é¦–å­—æ¯ä½œä¸ºé»˜è®¤æ˜¾ç¤º
    function getInitialLetter(title, url) {
      // ä¼˜å…ˆä½¿ç”¨æ ‡é¢˜
      if (title && title.trim()) {
        const firstChar = title.trim()[0].toUpperCase();
        // å¦‚æœæ˜¯ä¸­æ–‡æˆ–å…¶ä»–éASCIIå­—ç¬¦ï¼Œç›´æ¥è¿”å›
        if (firstChar.charCodeAt(0) > 127) {
          return firstChar;
        }
        // å¦‚æœæ˜¯è‹±æ–‡å­—æ¯ï¼Œè¿”å›å¤§å†™
        if (/[A-Za-z]/.test(firstChar)) {
          return firstChar;
        }
      }
      
      // å¦‚æœæ ‡é¢˜ä¸å¯ç”¨ï¼Œä»URLä¸­æå–åŸŸåé¦–å­—æ¯
      try {
        const hostname = new URL(url).hostname;
        const domainName = hostname.replace(/^www\./, '').split('.')[0];
        if (domainName) {
          return domainName[0].toUpperCase();
        }
      } catch (e) {
        // URLè§£æå¤±è´¥
      }
      
      // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆ
      return '?';
    }
    
    // é»˜è®¤æ˜¾ç¤ºé¦–å­—æ¯
    const initialLetter = getInitialLetter(l.title, l.url);
    faviconDiv.textContent = initialLetter;
    faviconDiv.setAttribute('data-initial', initialLetter);
    
    // å°è¯•åŠ è½½çœŸå®çš„favicon
    const logoSources = getLogoSources(l.url);
    let logoLoaded = false;
    
    // å°è¯•åŠ è½½Logo
    if (logoSources.length > 0) {
      let sourceIndex = 0;
      faviconDiv.classList.add('loading');
      
      function tryNextSource() {
        if (sourceIndex >= logoSources.length || logoLoaded) {
          faviconDiv.classList.remove('loading');
          // å¦‚æœæ‰€æœ‰æºéƒ½å¤±è´¥ï¼Œç¡®ä¿æ˜¾ç¤ºé¦–å­—æ¯
          if (!logoLoaded) {
            faviconDiv.textContent = initialLetter;
            faviconDiv.classList.add('initial-letter');
          }
          return;
        }
        
        const img = new Image();
        img.onload = function() {
          if (!logoLoaded && img.width > 0 && img.height > 0) {
            logoLoaded = true;
            faviconDiv.classList.remove('loading');
            
            // å¹³æ»‘è¿‡æ¸¡æ•ˆæœ
            faviconDiv.style.opacity = '0';
            setTimeout(() => {
              faviconDiv.innerHTML = '';
              faviconDiv.appendChild(img);
              faviconDiv.classList.add('has-logo');
              faviconDiv.classList.remove('initial-letter');
              faviconDiv.style.opacity = '1';
            }, 150);
          }
        };
        img.onerror = function() {
          sourceIndex++;
          setTimeout(tryNextSource, 200); // çŸ­æš‚å»¶è¿Ÿåå°è¯•ä¸‹ä¸€ä¸ªæº
        };
        
        // è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
        img.src = logoSources[sourceIndex];
        setTimeout(() => {
          if (!logoLoaded && sourceIndex < logoSources.length - 1) {
            img.src = ''; // å–æ¶ˆå½“å‰åŠ è½½
            sourceIndex++;
            tryNextSource();
          }
        }, 3000); // 3ç§’è¶…æ—¶
      }
      
      tryNextSource();
    } else {
      // æ²¡æœ‰å›¾æ ‡æºï¼Œç›´æ¥æ˜¾ç¤ºé¦–å­—æ¯
      faviconDiv.classList.add('initial-letter');
    }
    
    // åˆ›å»ºå…ƒæ•°æ®éƒ¨åˆ†
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<div class="title">${l.title}</div><div class="url">${l.url}</div>`;
    
    a.appendChild(faviconDiv);
    a.appendChild(meta);
    container.appendChild(a);
  })
}

// æ¸²æŸ“æ¡Œé¢ä¹¦ç­¾ï¼ˆå½“ç”¨æˆ·åœ¨è®¾ç½®ä¸­å¯ç”¨æ—¶ï¼‰
function renderDesktopBookmarks(){
  const container = $('#linksGrid');
  if (!container) return;

  if (!bookmarksEnabled) {
    // å¦‚æœæœªå¯ç”¨ï¼Œæ˜¾ç¤ºæ­£å¸¸çš„å¿«é€Ÿé“¾æ¥
    renderLinks();
    container.classList.remove('desktop-bookmarks');
    return;
  }

  container.innerHTML = '';
  container.classList.add('desktop-bookmarks');

  if (!bookmarks || bookmarks.length === 0) {
    container.innerHTML = `<div style="text-align:center;color:var(--muted);padding:24px;">æ²¡æœ‰æ¡Œé¢ä¹¦ç­¾ï¼Œæ‰“å¼€è®¾ç½® â†’ æ”¶è—å¤¹ æ·»åŠ </div>`;
    return;
  }

  // ä½¿ç”¨ DocumentFragment æ¥æ‰¹é‡æ’å…¥ DOM èŠ‚ç‚¹ï¼Œå‡å°‘é‡æ’
  const fragment = document.createDocumentFragment();
  const visibleBookmarks = bookmarks.filter(b => b.visible !== false);

  visibleBookmarks.forEach(b => {
    const a = document.createElement('a');
    a.className = 'link-card desktop-bookmark-card';
    a.href = b.url;
    a.target = '_blank';
    a.title = b.url;
    
    // ä½¿ç”¨ innerHTML å’Œæ¨¡æ¿å­—ç¬¦ä¸²æ›¿ä»£å¤§é‡ createElementï¼Œæå‡æ€§èƒ½
    let contentHTML = '<div class="desktop-bookmark-content" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;width:100%;">';
    
    if (b.showLogo !== false && b.favicon) {
      contentHTML += `<div class="desktop-bookmark-favicon" style="width:32px;height:32px;border-radius:6px;overflow:hidden;"><img src="${escapeHtml(b.favicon)}" style="width:100%;height:100%;object-fit:contain;"></div>`;
    }
    
    contentHTML += `<span style="font-size:13px;font-weight:500;">${escapeHtml(b.title || b.url)}</span>`;
    contentHTML += '</div>';
    
    a.innerHTML = contentHTML;
    
    // æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆä¿æŒäº‹ä»¶ç›‘å¬å™¨ï¼‰
    const editBtn = document.createElement('button');
    editBtn.className = 'bookmark-edit-btn';
    editBtn.innerHTML = 'â‹®';
    editBtn.type = 'button';
    editBtn.setAttribute('title', 'ç¼–è¾‘ä¹¦ç­¾');
    editBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openBookmarkEditor(b);
    });
    a.appendChild(editBtn);
    
    fragment.appendChild(a);
  });

  container.appendChild(fragment);
}

// æ‰“å¼€å•ä¸ªä¹¦ç­¾ç¼–è¾‘å™¨
function openBookmarkEditor(bookmark){
  const dialog = document.createElement('dialog');
  dialog.className = 'bookmark-editor-dialog';
  dialog.innerHTML = `
    <div class="bookmark-editor">
      <h3 style="margin-top:0;">ç¼–è¾‘ä¹¦ç­¾</h3>
      <div class="editor-field">
        <label>æ ‡é¢˜</label>
        <input type="text" id="editor-title" placeholder="ä¹¦ç­¾æ ‡é¢˜" value="${escapeHtml(bookmark.title || '')}">
      </div>
      <div class="editor-field">
        <label>é“¾æ¥</label>
        <input type="text" id="editor-url" placeholder="https://example.com" value="${escapeHtml(bookmark.url || '')}">
      </div>
      <div class="editor-field" style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="editor-show-logo" ${bookmark.showLogo !== false ? 'checked' : ''}>
        <label style="margin:0;flex:1;">æ˜¾ç¤º Logo</label>
      </div>
      ${bookmark.favicon ? `
        <div class="editor-field" style="text-align:center;">
          <img src="${bookmark.favicon}" style="max-width:48px;max-height:48px;border-radius:6px;">
          <small style="display:block;margin-top:6px;color:var(--muted);">Logo å·²åŠ è½½</small>
        </div>
      ` : `
        <div class="editor-field" style="text-align:center;">
          <small style="color:var(--muted);">Logo åŠ è½½ä¸­æˆ–å¤±è´¥...</small>
        </div>
      `}
      <div class="editor-actions">
        <button id="editor-reload-logo" class="btn-secondary" type="button">é‡æ–°åŠ è½½Logo</button>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="editor-cancel" class="btn-secondary" style="flex:1;">å–æ¶ˆ</button>
          <button id="editor-save" class="btn-primary" style="flex:1;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(dialog);
  
  const saveBtn = dialog.querySelector('#editor-save');
  const cancelBtn = dialog.querySelector('#editor-cancel');
  const reloadBtn = dialog.querySelector('#editor-reload-logo');
  const titleInput = dialog.querySelector('#editor-title');
  const urlInput = dialog.querySelector('#editor-url');
  const logoCheckbox = dialog.querySelector('#editor-show-logo');
  
  reloadBtn.addEventListener('click', () => {
    reloadBtn.disabled = true;
    reloadBtn.textContent = 'åŠ è½½ä¸­...';
    const url = urlInput.value.trim();
    if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
      bookmark.url = url;
      loadBookmarkFavicon(bookmark, null);
      setTimeout(() => {
        reloadBtn.disabled = false;
        reloadBtn.textContent = 'é‡æ–°åŠ è½½Logo';
        saveBookmarks();
        // åˆ·æ–°ç¼–è¾‘å™¨æ˜¾ç¤º
        if (bookmark.favicon) {
          const faviconDiv = dialog.querySelector('.editor-field img');
          if (faviconDiv) {
            faviconDiv.src = bookmark.favicon;
          }
        }
      }, 3500);
    } else {
      showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„URL');
      reloadBtn.disabled = false;
      reloadBtn.textContent = 'é‡æ–°åŠ è½½Logo';
    }
  });
  
  saveBtn.addEventListener('click', () => {
    bookmark.title = titleInput.value.trim() || bookmark.url;
    bookmark.url = urlInput.value.trim();
    bookmark.showLogo = logoCheckbox.checked;
    saveBookmarks();
    renderDesktopBookmarks();
    renderBookmarks();
    dialog.close();
    document.body.removeChild(dialog);
  });
  
  cancelBtn.addEventListener('click', () => {
    dialog.close();
    document.body.removeChild(dialog);
  });
  
  dialog.addEventListener('cancel', () => {
    document.body.removeChild(dialog);
  });
  
  dialog.showModal();
}

// editor dialog
function openEditor(){
  const dialog = $('#editDialog');
  const editor = $('#linksEditor');
  editor.innerHTML = '';
  links.forEach((l,idx)=>{
    const row = document.createElement('div');
    row.className = 'link-row';
    row.innerHTML = `<input class="title" placeholder="æ ‡é¢˜" value="${escapeHtml(l.title)}"><input class="url" placeholder="https://..." value="${escapeHtml(l.url)}"><button class="remove">åˆ é™¤</button>`;
    row.querySelector('.remove').addEventListener('click',()=>{ links.splice(idx,1); openEditor(); });
    editor.appendChild(row);
  });
  
  // ä¹Ÿæ¸²æŸ“æ”¶è—å¤¹ç¼–è¾‘å™¨
  renderBookmarksEditor();
  
  // ä¹Ÿæ¸²æŸ“æœç´¢å¼•æ“ç¼–è¾‘å™¨
  renderEnginesEditor();
  
  dialog.showModal();
}

// æ¸²æŸ“æ”¶è—å¤¹ç¼–è¾‘å™¨
function renderBookmarksEditor(){
  const container = document.getElementById('bookmarksEditor');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (bookmarks.length === 0) {
    container.innerHTML = `<div style="text-align:center;color:var(--muted);padding:20px;">è¿˜æ²¡æœ‰æ”¶è—å¤¹</div>`;
    return;
  }
  
  // æ·»åŠ è¡¨å¤´
  const header = document.createElement('div');
  header.style.cssText = 'display:grid;grid-template-columns:40px 1fr 50px;gap:12px;align-items:center;padding:8px;margin-bottom:12px;border-bottom:1px solid var(--control-border);font-weight:600;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;';
  header.innerHTML = `
    <div style="text-align:center;">æ˜¾ç¤º</div>
    <div>ä¹¦ç­¾</div>
    <div></div>
  `;
  container.appendChild(header);
  
  bookmarks.forEach((b, idx) => {
    const row = document.createElement('div');
    row.className = 'bookmark-row';
    row.style.cssText = 'display:grid;grid-template-columns:40px 1fr 50px;gap:12px;align-items:center;padding:12px;border-radius:8px;border:1px solid var(--control-border);margin-bottom:8px;transition:all 0.2s;background:var(--control-bg);';
    
    row.addEventListener('mouseenter', () => {
      row.style.background = 'var(--control-bg-hover)';
      row.style.borderColor = 'rgba(0, 122, 255, 0.3)';
    });
    
    row.addEventListener('mouseleave', () => {
      row.style.background = 'var(--control-bg)';
      row.style.borderColor = 'var(--control-border)';
    });
    
    // å¯è§æ€§å¤é€‰æ¡†
    const checkboxDiv = document.createElement('div');
    checkboxDiv.style.cssText = 'display:flex;align-items:center;justify-content:center;';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = b.visible !== false;
    checkbox.style.cssText = 'width:18px;height:18px;cursor:pointer;';
    checkbox.title = 'æ˜¾ç¤º/éšè—';
    checkbox.addEventListener('change', (e) => {
      b.visible = e.target.checked;
      saveBookmarks();
      renderDesktopBookmarks();
    });
    checkboxDiv.appendChild(checkbox);
    
    // æ ‡é¢˜å’ŒURL
    const info = document.createElement('div');
    info.style.cssText = 'min-width:0;';
    info.innerHTML = `
      <div style="font-size:14px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(b.title)}</div>
      <div style="font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px;">${escapeHtml(b.url)}</div>
    `;
    
    // ç¼–è¾‘æŒ‰é’®
    const btnDiv = document.createElement('div');
    btnDiv.style.cssText = 'display:flex;justify-content:center;';
    const editBtn = document.createElement('button');
    editBtn.className = 'icon-btn';
    editBtn.type = 'button';
    editBtn.title = 'ç¼–è¾‘';
    editBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    editBtn.style.cssText = 'padding:6px;';
    editBtn.addEventListener('click', (e) => {
      e.preventDefault();
      $('#editDialog').close();
      setTimeout(() => openBookmarkEditor(b), 100);
    });
    btnDiv.appendChild(editBtn);
    
    row.appendChild(checkboxDiv);
    row.appendChild(info);
    row.appendChild(btnDiv);
    container.appendChild(row);
  });
}

// æ¸²æŸ“æœç´¢å¼•æ“ç¼–è¾‘å™¨
function renderEnginesEditor(){
  const container = document.getElementById('enginesEditor');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (searchEngines.length === 0) {
    container.innerHTML = `<div style="text-align:center;color:var(--muted);padding:20px;">è¿˜æ²¡æœ‰æœç´¢å¼•æ“</div>`;
    return;
  }
  
  // æ·»åŠ è¡¨å¤´
  const header = document.createElement('div');
  header.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 80px;gap:12px;align-items:center;padding:8px;margin-bottom:12px;border-bottom:1px solid var(--control-border);font-weight:600;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;';
  header.innerHTML = `
    <div>åç§°</div>
    <div>æœç´¢URL</div>
    <div></div>
  `;
  container.appendChild(header);
  
  searchEngines.forEach((engine, idx) => {
    const row = document.createElement('div');
    row.className = 'engine-row';
    row.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 80px;gap:12px;align-items:center;padding:12px;border-radius:8px;border:1px solid var(--control-border);margin-bottom:8px;transition:all 0.2s;background:var(--control-bg);';
    
    row.addEventListener('mouseenter', () => {
      row.style.background = 'var(--control-bg-hover)';
      row.style.borderColor = 'rgba(0, 122, 255, 0.3)';
    });
    
    row.addEventListener('mouseleave', () => {
      row.style.background = 'var(--control-bg)';
      row.style.borderColor = 'var(--control-border)';
    });
    
    // åç§°å’ŒURLä¿¡æ¯
    const nameDiv = document.createElement('div');
    nameDiv.style.cssText = 'font-size:14px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';
    nameDiv.textContent = engine.name;
    
    const urlDiv = document.createElement('div');
    urlDiv.style.cssText = 'font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';
    urlDiv.textContent = engine.url;
    
    // ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
    const btnDiv = document.createElement('div');
    btnDiv.style.cssText = 'display:flex;gap:6px;justify-content:flex-end;';
    
    const editBtn = document.createElement('button');
    editBtn.className = 'icon-btn';
    editBtn.type = 'button';
    editBtn.title = 'ç¼–è¾‘';
    editBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    editBtn.style.cssText = 'padding:6px;';
    editBtn.addEventListener('click', (e) => {
      e.preventDefault();
      openEngineEditor(engine, idx);
    });
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'icon-btn';
    deleteBtn.type = 'button';
    deleteBtn.title = 'åˆ é™¤';
    deleteBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 6H5v13a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V6z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M9 11v6m6-6v6M10 6V4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    deleteBtn.style.cssText = 'padding:6px;';
    deleteBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm(`ç¡®å®šè¦åˆ é™¤ "${engine.name}" å—ï¼Ÿ`)) {
        searchEngines.splice(idx, 1);
        saveSearchEngines();
        syncEngineSelect();
        renderEnginesEditor();
      }
    });
    
    btnDiv.appendChild(editBtn);
    btnDiv.appendChild(deleteBtn);
    
    row.appendChild(nameDiv);
    row.appendChild(urlDiv);
    row.appendChild(btnDiv);
    container.appendChild(row);
  });
  
  // æ·»åŠ "æ·»åŠ æœç´¢å¼•æ“"æŒ‰é’®
  const addBtn = document.createElement('button');
  addBtn.className = 'btn primary';
  addBtn.textContent = '+ æ·»åŠ æœç´¢å¼•æ“';
  addBtn.style.cssText = 'margin-top:12px;width:100%;';
  addBtn.addEventListener('click', (e) => {
    e.preventDefault();
    openEngineEditor(null, -1);
  });
  container.appendChild(addBtn);
}

// æ‰“å¼€æœç´¢å¼•æ“ç¼–è¾‘å¯¹è¯æ¡†
function openEngineEditor(engine, idx) {
  const name = engine ? engine.name : '';
  const url = engine ? engine.url : '';
  const isEdit = engine !== null;
  
  const dialog = document.createElement('div');
  dialog.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel-bg);border:1px solid var(--control-border);border-radius:12px;padding:24px;z-index:3000;box-shadow:0 8px 32px rgba(0,0,0,0.2);min-width:400px;';
  
  dialog.innerHTML = `
    <div style="font-size:18px;font-weight:600;margin-bottom:16px;color:var(--text);">${isEdit ? 'ç¼–è¾‘æœç´¢å¼•æ“' : 'æ·»åŠ æœç´¢å¼•æ“'}</div>
    <div style="margin-bottom:16px;">
      <label style="display:block;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:6px;">åç§°</label>
      <input type="text" id="engineName" placeholder="ä¾‹å¦‚ï¼šGoogle" value="${escapeHtml(name)}" style="width:100%;padding:10px 12px;border:1px solid var(--control-border);border-radius:6px;background:var(--input-bg);color:var(--text);font-size:14px;box-sizing:border-box;">
    </div>
    <div style="margin-bottom:20px;">
      <label style="display:block;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:6px;">æœç´¢URL (ç”¨ {0} æˆ– {q} è¡¨ç¤ºæœç´¢è¯)</label>
      <input type="text" id="engineUrl" placeholder="ä¾‹å¦‚ï¼šhttps://www.google.com/search?q=" value="${escapeHtml(url)}" style="width:100%;padding:10px 12px;border:1px solid var(--control-border);border-radius:6px;background:var(--input-bg);color:var(--text);font-size:14px;box-sizing:border-box;">
    </div>
    <div style="display:flex;gap:12px;justify-content:flex-end;">
      <button id="cancelBtn" class="btn" style="flex:1;">å–æ¶ˆ</button>
      <button id="saveBtn" class="btn primary" style="flex:1;">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
    </div>
  `;
  
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:2999;';
  
  document.body.appendChild(overlay);
  document.body.appendChild(dialog);
  
  const nameInput = document.getElementById('engineName');
  const urlInput = document.getElementById('engineUrl');
  
  nameInput.focus();
  
  document.getElementById('cancelBtn').addEventListener('click', () => {
    overlay.remove();
    dialog.remove();
  });
  
  document.getElementById('saveBtn').addEventListener('click', () => {
    const newName = nameInput.value.trim();
    const newUrl = urlInput.value.trim();
    
    if (!newName) {
      alert('è¯·è¾“å…¥æœç´¢å¼•æ“åç§°');
      return;
    }
    if (!newUrl) {
      alert('è¯·è¾“å…¥æœç´¢URL');
      return;
    }
    
    if (isEdit) {
      searchEngines[idx].name = newName;
      searchEngines[idx].url = newUrl;
    } else {
      searchEngines.push({ name: newName, url: newUrl });
    }
    
    saveSearchEngines();
    syncEngineSelect();
    renderEnginesEditor();
    
    overlay.remove();
    dialog.remove();
  });
  
  overlay.addEventListener('click', () => {
    overlay.remove();
    dialog.remove();
  });
}

function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

function saveEditor(){
  const editor = $('#linksEditor');
  const rows = Array.from(editor.querySelectorAll('.link-row'));
  const newLinks = rows.map(r=>({title: r.querySelector('.title').value.trim(), url: r.querySelector('.url').value.trim()})).filter(x=>x.url);
  links = newLinks.length? newLinks : defaultLinks;
  saveState();
  renderLinks();
  $('#editDialog').close();
}

// add link row
function addLinkRow(){
  const editor = $('#linksEditor');
  const row = document.createElement('div');
  row.className = 'link-row';
  row.innerHTML = `<input class="title" placeholder="æ ‡é¢˜"><input class="url" placeholder="https://..."><button class="remove">åˆ é™¤</button>`;
  row.querySelector('.remove').addEventListener('click',()=>{ row.remove(); });
  editor.appendChild(row);
}

// æ”¶è—å¤¹ç®¡ç†ï¼ˆä»£ç å·²ç§»åŠ¨åˆ°æ–‡ä»¶é¡¶éƒ¨ï¼‰

function openBookmarksPanel() {
  const settingsPanel = document.getElementById('settingsPanel');
  if (settingsPanel) settingsPanel.classList.remove('show');
  const panel = document.getElementById('bookmarksPanel');
  const overlay = document.getElementById('bookmarksOverlay');

  if (panel) {
    panel.classList.add('open');
    panel.classList.remove('hidden');
  } else {
    console.error('æ‰¾ä¸åˆ°æ”¶è—å¤¹é¢æ¿å…ƒç´ ');
  }

  if (overlay) {
    overlay.classList.add('open');
    overlay.classList.remove('hidden');
  } else {
    console.error('æ‰¾ä¸åˆ°é®ç½©å…ƒç´ ');
  }
  
  // æš‚æ—¶æ³¨é‡Šæ‰å¯èƒ½æœ‰é—®é¢˜çš„æ¸²æŸ“å‡½æ•°
  try {
    renderBookmarks();
    // after render, play staggered entrance animation
    requestAnimationFrame(() => playBookmarkEntrance());
  } catch (error) {
    console.error('æ¸²æŸ“ä¹¦ç­¾æ—¶å‡ºé”™:', error);
  }
}

function closeBookmarksPanel() {
  const panel = document.getElementById('bookmarksPanel');
  const overlay = document.getElementById('bookmarksOverlay');

  if (panel) {
    panel.classList.remove('open');
    // wait for animation then hide
    setTimeout(() => panel.classList.add('hidden'), 380);
  }
  if (overlay) {
    overlay.classList.remove('open');
    setTimeout(() => overlay.classList.add('hidden'), 320);
  }
  // ä¸ç§»é™¤ visible çŠ¶æ€ï¼Œä¿æŒ DOM çŠ¶æ€ä¸€è‡´
}

// Fast entrance for bookmark items - show all at once with CSS animation
function playBookmarkEntrance() {
  const items = document.querySelectorAll('#bookmarksList .bookmark-item');
  if (!items.length) return;
  // ä¸€æ¬¡æ€§æ·»åŠ  visible ç±»ï¼Œç”± CSS åŠ¨ç”»æ§åˆ¶
  items.forEach(it => it.classList.add('visible'));
}

function saveBookmarks() {
  localStorage.setItem('startpage.bookmarks', JSON.stringify(bookmarks));
  // æ›´æ–°æ¡Œé¢è§†å›¾ï¼ˆå¦‚æœå¯ç”¨ï¼‰
  renderDesktopBookmarks();
}

function addBookmark(title, url, folder = 'default') {
  const bookmark = {
    id: Date.now(),
    title: title.trim(),
    url: url.trim(),
    folder,
    favicon: null,
    visible: true, // é»˜è®¤æ˜¾ç¤º
    showLogo: true, // é»˜è®¤æ˜¾ç¤ºlogo
    timestamp: Date.now()
  };
  
  bookmarks.push(bookmark);
  saveBookmarks();
  renderBookmarks();
  showToast('ä¹¦ç­¾å·²æ·»åŠ ');
  
  // å¼‚æ­¥åŠ è½½favicon
  loadBookmarkFavicon(bookmark, null);
  
  renderDesktopBookmarks();
}

function removeBookmark(id) {
  bookmarks = bookmarks.filter(b => b.id !== id);
  saveBookmarks();
  renderBookmarks();
  renderDesktopBookmarks();
}

function renderBookmarks(searchTerm = '') {
  const container = document.getElementById('bookmarksList');
  container.innerHTML = '';
  
  if (bookmarks.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
        <p>è¿˜æ²¡æœ‰æ”¶è—å¤¹</p>
        <p>ç‚¹å‡» + æŒ‰é’®æ·»åŠ ä¹¦ç­¾ï¼Œæˆ–å¯¼å…¥ä¹¦ç­¾æ–‡ä»¶</p>
      </div>
    `;
    return;
  }
  
  // ç­›é€‰ä¹¦ç­¾ï¼ˆä¸æ ¹æ®visibleè¿‡æ»¤ï¼Œè¿™æ ·éšè—çš„ä¹¦ç­¾ä¹Ÿèƒ½çœ‹åˆ°ï¼‰
  const filtered = bookmarks.filter(bookmark => 
    bookmark.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
    bookmark.url.toLowerCase().includes(searchTerm.toLowerCase())
  );
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--muted);">
        <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¹¦ç­¾</p>
      </div>
    `;
    return;
  }
  
  // æ¸²æŸ“ä¹¦ç­¾ - ä½¿ç”¨ DocumentFragment ä¼˜åŒ–æ€§èƒ½
  const fragment = document.createDocumentFragment();
  
  filtered.forEach(bookmark => {
    const item = document.createElement('div');
    item.className = 'bookmark-item';
    item.dataset.bookmarkId = bookmark.id; // å­˜å‚¨ ID ä¾¿äºäº‹ä»¶å§”æ‰˜
    
    // å¦‚æœä¹¦ç­¾éšè—ï¼Œæ·»åŠ æ ·å¼ä½†ä¿æŒå¯äº¤äº’
    if (bookmark.visible === false) {
      item.style.opacity = '0.5';
      item.onclick = (e) => e.preventDefault();
    }
    
    // ä½¿ç”¨ innerHTML åˆ›å»ºå›¾æ ‡å’Œå†…å®¹ï¼Œæå‡æ€§èƒ½
    let iconHTML = '';
    if (bookmark.favicon) {
      iconHTML = `<div class="bookmark-icon"><img src="${escapeHtml(bookmark.favicon)}" onerror="this.parentElement.innerHTML='${bookmark.title.charAt(0).toUpperCase()}'"></div>`;
    } else {
      iconHTML = `<div class="bookmark-icon">${bookmark.title.charAt(0).toUpperCase()}</div>`;
    }
    
    item.innerHTML = `
      <a href="${bookmark.url}" target="_blank" class="bookmark-link-content" style="display:flex;align-items:center;gap:12px;flex:1;min-width:0;text-decoration:none;color:inherit;">
        ${iconHTML}
        <div class="bookmark-content">
          <div class="bookmark-title">${escapeHtml(bookmark.title)}</div>
          <div class="bookmark-url">${escapeHtml(bookmark.url)}</div>
        </div>
      </a>
      <button class="icon-btn visibility-btn" type="button" style="opacity:0;" title="${bookmark.visible !== false ? 'éšè—ä¹¦ç­¾' : 'æ˜¾ç¤ºä¹¦ç­¾'}" data-action="toggle-visibility">
        ${bookmark.visible !== false ? `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 5C7 5 2.73 8.11 1 12.46c1.73 4.35 6 7.54 11 7.54s9.27-3.19 11-7.54C21.27 8.11 17 5 12 5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
          </svg>
        ` : `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-5 0-9.27-3.19-11-7.54.5-1.35 1.26-2.62 2.22-3.74M9.88 9.88a3 3 0 0 0 4.24 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `}
      </button>
      <button class="icon-btn delete-btn" type="button" style="opacity:0;" title="åˆ é™¤ä¹¦ç­¾" data-action="delete">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.5 3.5L3.5 10.5M3.5 3.5L10.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    `;
    
    // æ‚¬åœæ˜¾ç¤ºæŒ‰é’®
    item.addEventListener('mouseenter', () => {
      item.querySelector('.visibility-btn').style.opacity = '1';
      item.querySelector('.delete-btn').style.opacity = '1';
    });
    item.addEventListener('mouseleave', () => {
      item.querySelector('.visibility-btn').style.opacity = '0';
      item.querySelector('.delete-btn').style.opacity = '0';
    });
    
    fragment.appendChild(item);
  });

  container.appendChild(fragment);
  
  // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æŒ‰é’®ç‚¹å‡» - å·²ç§»åŠ¨åˆ°åˆå§‹åŒ–å‡½æ•°ä¸­ï¼Œé¿å…é‡å¤ç»‘å®š
}

// äº‹ä»¶å§”æ‰˜å¤„ç†ä¹¦ç­¾åˆ—è¡¨ä¸­çš„æ‰€æœ‰æŒ‰é’®æ“ä½œ
function handleBookmarkActions(e) {
  const action = e.target.closest('[data-action]');
  if (!action) return;
  
  const item = e.target.closest('.bookmark-item');
  if (!item) return;
  
  // ä½¿ç”¨ Number è€Œä¸æ˜¯ parseIntï¼Œå› ä¸º id å¯èƒ½æ˜¯æµ®ç‚¹æ•° (Date.now() + Math.random())
  const bookmarkId = Number(item.dataset.bookmarkId);
  const bookmark = bookmarks.find(b => b.id === bookmarkId);
  if (!bookmark) return;
  
  const actionType = action.getAttribute('data-action');
  
  if (actionType === 'delete') {
    e.preventDefault();
    e.stopPropagation();
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹¦ç­¾å—ï¼Ÿ')) {
      removeBookmark(bookmark.id);
    }
  } else if (actionType === 'toggle-visibility') {
    e.preventDefault();
    e.stopPropagation();
    bookmark.visible = bookmark.visible === false ? true : false;
    saveBookmarks();
    const searchTerm = document.getElementById('bookmarksSearch')?.value || '';
    renderBookmarks(searchTerm);
    renderDesktopBookmarks();
    showToast(bookmark.visible ? 'å·²æ˜¾ç¤ºä¹¦ç­¾' : 'å·²éšè—ä¹¦ç­¾');
  }
}

function loadBookmarkFavicon(bookmark, iconElement) {
  // ä½¿ç”¨ requestIdleCallback å»¶è¿ŸåŠ è½½ faviconï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      loadFaviconInternal(bookmark, iconElement);
    }, { timeout: 5000 });
  } else {
    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ setTimeout
    setTimeout(() => {
      loadFaviconInternal(bookmark, iconElement);
    }, 100);
  }
}

function loadFaviconInternal(bookmark, iconElement) {
  try {
    const hostname = new URL(bookmark.url).hostname;
    const candidates = [
      `https://www.google.com/s2/favicons?domain=${hostname}&sz=64`,
      `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`,
      `https://icons.duckduckgo.com/ip3/${hostname}.ico`,
      `https://${hostname}/favicon.ico`
    ];

    let tried = 0;
    let loaded = false;

    function tryLoad(src) {
      if (loaded) return;
      const img = new Image();
      let done = false;
      const timeout = setTimeout(() => {
        done = true;
        img.src = '';
        next();
      }, 3000);

      img.onload = function() {
        if (done) return;
        clearTimeout(timeout);
        if (img.width > 0 && img.height > 0) {
          loaded = true;
          bookmark.favicon = src;
          saveBookmarks();
          
          if (iconElement) {
            iconElement.innerHTML = '';
            img.width = 40;
            img.height = 40;
            img.style.borderRadius = '8px';
            iconElement.appendChild(img);
          }
          
          renderDesktopBookmarks();
        } else {
          next();
        }
      };
      img.onerror = function() {
        if (done) return;
        clearTimeout(timeout);
        next();
      };
      img.src = src;
    }

    function next() {
      tried++;
      if (tried >= candidates.length) return;
      tryLoad(candidates[tried]);
    }

    tryLoad(candidates[0]);
  } catch (e) {
    // URLæ— æ•ˆï¼Œä¿æŒé»˜è®¤æ˜¾ç¤º
  }
}

function handleBookmarkImport() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.html,.json';
  input.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          parseBookmarkFile(e.target.result, file.type);
        } catch (error) {
          showToast('ä¹¦ç­¾æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
          console.error('ä¹¦ç­¾å¯¼å…¥å¤±è´¥:', error);
        }
      };
      reader.readAsText(file);
    }
  });
  input.click();
}

function parseBookmarkFile(content, fileType) {
  let importedBookmarks = [];
  
  if (fileType.includes('json')) {
    // JSONæ ¼å¼
    const data = JSON.parse(content);
    importedBookmarks = data.map(item => ({
      id: Date.now() + Math.random(),
      title: item.title || item.name || 'Untitled',
      url: item.url || item.href,
      folder: 'imported',
      favicon: null,
      visible: true,
      showLogo: true,
      timestamp: Date.now()
    }));
  } else {
    // HTMLæ ¼å¼ (Edge/Chromeä¹¦ç­¾å¯¼å‡ºæ ¼å¼)
    const parser = new DOMParser();
    const doc = parser.parseFromString(content, 'text/html');
    const links = doc.querySelectorAll('a[href]');
    
    links.forEach(link => {
      if (link.href && link.href.startsWith('http')) {
        importedBookmarks.push({
          id: Date.now() + Math.random(),
          title: link.textContent.trim() || 'Untitled',
          url: link.href,
          folder: 'imported',
          favicon: null,
          visible: true,
          showLogo: true,
          timestamp: Date.now()
        });
      }
    });
  }
  
  if (importedBookmarks.length > 0) {
    // Filter out items without valid URL and dedupe against existing bookmarks
    const existingUrls = new Set(bookmarks.map(b => b.url));
    const validImported = importedBookmarks.filter(b => b.url && typeof b.url === 'string' && b.url.startsWith('http') && !existingUrls.has(b.url));
    if (validImported.length > 0) {
      bookmarks = [...bookmarks, ...validImported];
      saveBookmarks();
      renderBookmarks();
      // play entrance animation for newly rendered items
      requestAnimationFrame(() => playBookmarkEntrance());
      showToast(`æˆåŠŸå¯¼å…¥ ${validImported.length} ä¸ªä¹¦ç­¾`);
      
      // å¼‚æ­¥åŠ è½½æ‰€æœ‰å¯¼å…¥ä¹¦ç­¾çš„favicon
      validImported.forEach(b => {
        loadBookmarkFavicon(b, null);
      });
    } else {
      showToast('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæˆ–æ–°çš„ä¹¦ç­¾å¯å¯¼å…¥');
    }
  } else {
    showToast('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¹¦ç­¾');
  }
}

function exportBookmarks() {
  const data = JSON.stringify(bookmarks, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `startpage-bookmarks-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  
  URL.revokeObjectURL(url);
  showToast('ä¹¦ç­¾å·²å¯¼å‡º');
}

function promptAddBookmark() {
  const title = prompt('ä¹¦ç­¾æ ‡é¢˜:');
  if (!title) return;
  
  const url = prompt('ä¹¦ç­¾åœ°å€:');
  if (!url) return;
  
  // ç®€å•çš„URLéªŒè¯
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„URL (ä»¥http://æˆ–https://å¼€å¤´)');
    return;
  }
  
  addBookmark(title, url);
}

// search
// æœç´¢è®°å½•ç®¡ç†
let searchHistory = JSON.parse(localStorage.getItem('startpage.searchHistory') || '[]');

function saveSearchHistory(query, engine) {
  // å¦‚æœæ²¡æœ‰æä¾› query å’Œ engineï¼Œè¡¨ç¤ºåªæ˜¯ä¿å­˜å½“å‰æ•°æ®åˆ° localStorage
  if (query === undefined && engine === undefined) {
    localStorage.setItem('startpage.searchHistory', JSON.stringify(searchHistory));
    return;
  }
  
  // é¿å…ä¿å­˜URLå’Œé‡å¤é¡¹
  if (isProbablyUrl(query) || !query.trim()) return;
  
  const record = {
    query: query.trim(),
    engine: engine,
    timestamp: Date.now()
  };
  
  // ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒæœç´¢
  searchHistory = searchHistory.filter(item => 
    !(item.query === record.query && item.engine === record.engine)
  );
  
  // æ·»åŠ åˆ°å¼€å¤´
  searchHistory.unshift(record);
  
  // é™åˆ¶è®°å½•æ•°é‡ï¼ˆæœ€å¤š6æ¡ï¼‰
  if (searchHistory.length > 6) {
    searchHistory = searchHistory.slice(0, 6);
  }
  
  localStorage.setItem('startpage.searchHistory', JSON.stringify(searchHistory));
}

function clearSearchHistory() {
  searchHistory = [];
  localStorage.removeItem('startpage.searchHistory');
  hideSearchSuggestions();
  showToast('æœç´¢è®°å½•å·²æ¸…ç©º');
}

function showSearchSuggestions() {
  const input = $('#searchInput');
  const suggestions = $('#searchSuggestions');
  const query = input.value.trim().toLowerCase();
  
  if (query.length === 0) {
    // æ˜¾ç¤ºæœ€è¿‘çš„æœç´¢è®°å½•
    renderSearchSuggestions(searchHistory.slice(0, 6));
  } else {
    // ç­›é€‰åŒ¹é…çš„æœç´¢è®°å½• - æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶å¤„ç†èŒƒå›´
    const filtered = searchHistory
      .filter(item => item.query.toLowerCase().includes(query))
      .slice(0, 6);
    renderSearchSuggestions(filtered);
  }
}

function renderSearchSuggestions(items) {
  const suggestions = $('#searchSuggestions');
  suggestions.innerHTML = '';
  
  if (items.length === 0 && searchHistory.length === 0) {
    suggestions.classList.add('hidden');
    return;
  }
  
  // ä½¿ç”¨ DocumentFragment ä¼˜åŒ– DOM æ’å…¥
  const fragment = document.createDocumentFragment();
  
  items.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'search-suggestion-item';
    
    // åˆ›å»ºå¼•æ“é€‰æ‹©å™¨
    let engineOptions = '';
    searchEngines.forEach(engine => {
      const selected = engine.url === item.engine ? 'selected' : '';
      engineOptions += `<option value="${engine.url}" ${selected}>${engine.name}</option>`;
    });
    
    div.innerHTML = `
      <span class="search-suggestion-text" style="cursor:pointer;flex:1;">${escapeHtml(item.query)}</span>
      <select class="search-suggestion-engine-select" style="padding:4px 8px;border:1px solid var(--control-border);border-radius:4px;background:var(--control-bg);color:var(--text);font-size:12px;cursor:pointer;">
        ${engineOptions}
      </select>
      <span class="search-suggestion-time">${formatTime(item.timestamp)}</span>
    `;
    
    // æ–‡æœ¬ç‚¹å‡»æ—¶ç”¨å½“å‰é€‰ä¸­çš„å¼•æ“æœç´¢
    const textSpan = div.querySelector('.search-suggestion-text');
    textSpan.addEventListener('click', () => {
      const engineSelect = div.querySelector('.search-suggestion-engine-select');
      $('#searchInput').value = item.query;
      $('#engineSelect').value = engineSelect.value;
      hideSearchSuggestions();
      onSearch(new Event('submit'));
    });
    
    // å¼•æ“é€‰æ‹©å™¨æ”¹å˜æ—¶çš„å¤„ç†
    const engineSelect = div.querySelector('.search-suggestion-engine-select');
    // pointerdown æ—¶é˜»æ­¢å†’æ³¡å¹¶è®¾ç½®æ ‡è®°ï¼Œé¿å… blur å®šæ—¶å™¨éšè—å»ºè®®
    engineSelect.addEventListener('pointerdown', (e) => {
      e.stopPropagation();
      preventHideSuggestions = true;
    });
    engineSelect.addEventListener('change', (e) => {
      e.stopPropagation();
      // æ›´æ–°æœç´¢å†å²ä¸­è¯¥é¡¹çš„å¼•æ“å¹¶æŒä¹…åŒ–
      item.engine = e.target.value;
      saveSearchHistory();
      // åœ¨çŸ­æ—¶é—´å†…é˜»æ­¢å»ºè®®è¢«éšè—
      setTimeout(() => { preventHideSuggestions = false; }, 300);
    });
    
    fragment.appendChild(div);
  });
  
  // æ·»åŠ æ¸…ç©ºè®°å½•æŒ‰é’®
  if (searchHistory.length > 0) {
    const clearBtn = document.createElement('button');
    clearBtn.className = 'clear-history-btn';
    clearBtn.textContent = 'æ¸…ç©ºæœç´¢è®°å½•';
    clearBtn.addEventListener('click', clearSearchHistory);
    fragment.appendChild(clearBtn);
  }
  
  suggestions.appendChild(fragment);
  suggestions.classList.remove('hidden');
}

function hideSearchSuggestions() {
  const suggestions = $('#searchSuggestions');
  suggestions.classList.add('hidden');
}

function getEngineName(engineUrl) {
  if (engineUrl.includes('google.com')) return 'Google';
  if (engineUrl.includes('bing.com')) return 'Bing';
  if (engineUrl.includes('baidu.com')) return 'ç™¾åº¦';
  if (engineUrl.includes('duckduckgo.com')) return 'DuckDuckGo';
  return 'æœç´¢';
}

function formatTime(timestamp) {
  const now = Date.now();
  const diff = now - timestamp;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return 'åˆšåˆš';
  if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
  if (hours < 24) return `${hours}å°æ—¶å‰`;
  if (days < 7) return `${days}å¤©å‰`;
  return new Date(timestamp).toLocaleDateString();
}

function onSearch(e){
  e.preventDefault();
  const q = $('#searchInput').value.trim();
  const engine = $('#engineSelect').value;
  if(!q) return;
  
  // ä¿å­˜æœç´¢è®°å½•
  saveSearchHistory(q, engine);
  
  if(isProbablyUrl(q)){
    const url = q.startsWith('http')? q : 'https://' + q;
    window.location.href = url;
  }else{
    window.open(engine + encodeURIComponent(q), '_blank');
  }
  
  // æ¸…ç©ºæœç´¢æ¡†å¹¶éšè—å»ºè®®
  $('#searchInput').value = '';
  hideSearchSuggestions();
}

function isProbablyUrl(s){
  return /\.|\//.test(s);
}

// theme
function loadTheme(){
  const t = localStorage.getItem('startpage.theme') || 'light';
  if(t === 'dark') document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.removeAttribute('data-theme');
  const btn = $('#themeToggle');
  if(btn) btn.setAttribute('aria-pressed', t === 'dark' ? 'true' : 'false');
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark':'light';
  const next = cur === 'dark' ? 'light' : 'dark';
  if(next === 'dark') document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.removeAttribute('data-theme');
  localStorage.setItem('startpage.theme', next);
  // if sync enabled, mirror to body using data-dark-mode attribute
  const sync = localStorage.getItem('startpage.syncBody') === 'true';
  if(sync){
    if(next === 'dark') document.body.setAttribute('data-dark-mode','true');
    else document.body.removeAttribute('data-dark-mode');
  }
  loadTheme();
}

function loadSync(){
  const s = localStorage.getItem('startpage.syncBody') === 'true';
  const el = $('#syncBody');
  if(el) el.checked = s;
}

function bindSync(){
  const el = $('#syncBody');
  if(!el) return;
  el.addEventListener('change', ()=>{
    localStorage.setItem('startpage.syncBody', el.checked ? 'true' : 'false');
    // apply immediately
    if(el.checked){
      const dark = document.documentElement.getAttribute('data-theme') === 'dark';
      if(dark) document.body.setAttribute('data-dark-mode','true');
      else document.body.removeAttribute('data-dark-mode');
    }else{
      document.body.removeAttribute('data-dark-mode');
    }
  });
}

// èƒŒæ™¯è®¾ç½®
let currentBg = '';
let currentBgType = 'color';

// åŠ è½½ä¿å­˜çš„èƒŒæ™¯ï¼ˆåŒæ—¶æ”¯æŒlocalStorageå’ŒIndexedDBï¼‰
// ==================== ç»ˆææ€§èƒ½ä¼˜åŒ–ç³»ç»Ÿ ====================
// æ€§èƒ½ç›‘æ§
const perfMetrics = { startTime: performance.now(), checkpoints: {} };
function markCheckpoint(name) {
    perfMetrics.checkpoints[name] = performance.now() - perfMetrics.startTime;
    console.log(`âœ“ ${name}: ${perfMetrics.checkpoints[name].toFixed(0)}ms`);
}

// æé€ŸåŠ è½½ä¿å­˜çš„èƒŒæ™¯
async function loadSavedBackground() {
    const cachedVideo = document.getElementById('videoBgPlayer');
    if (cachedVideo && !cachedVideo.paused) {
        markCheckpoint('å†…å­˜ç¼“å­˜å‘½ä¸­');
        return;
    }
    
    const bgType = localStorage.getItem('startpage.bgType') || 'color';
    
    // éè§†é¢‘ç±»å‹ï¼šåŒæ­¥åŠ è½½ï¼ˆ<3msï¼‰
    if (bgType !== 'video') {
        const localBg = localStorage.getItem('startpage.bg');
        if (localBg) {
            currentBg = localBg;
            currentBgType = bgType;
            applyBackground();
            markCheckpoint(`èƒŒæ™¯åŠ è½½: ${bgType}`);
        }
        return;
    }
    
    // è§†é¢‘ç±»å‹ï¼šæ£€æŸ¥æ•°æ®æ¥æº
    const localBg = localStorage.getItem('startpage.bg');
    
    // æƒ…å†µ1: IndexedDBæ ‡è®° - ä»æ•°æ®åº“åŠ è½½Blobï¼ˆâš¡æé€Ÿï¼‰
    if (localBg === 'INDEXED_DB_VIDEO') {
        console.log('âš¡ ä»IndexedDBåŠ è½½è‡ªå®šä¹‰è§†é¢‘ï¼ˆBlobæ¨¡å¼ï¼‰');
        const loadStart = performance.now();
        
        try {
            if (!db) await initIndexedDB();
            const dbData = await loadBackgroundFromDB();
            
            if (dbData?.data) {
                // ğŸš€ æ€§èƒ½å…³é”®ï¼šä»Blobåˆ›å»ºObject URLï¼ˆ<10msï¼‰
                let videoUrl;
                if (dbData.data instanceof Blob) {
                    videoUrl = URL.createObjectURL(dbData.data);
                    console.log('âœ… Blobè½¬URLå®Œæˆ');
                } else if (typeof dbData.data === 'string' && dbData.data.startsWith('data:')) {
                    // å…¼å®¹æ—§çš„base64æ•°æ®
                    videoUrl = dbData.data;
                    console.log('âš ï¸ ä½¿ç”¨æ—§base64æ ¼å¼ï¼ˆè¾ƒæ…¢ï¼‰');
                } else {
                    throw new Error('æœªçŸ¥çš„è§†é¢‘æ•°æ®æ ¼å¼');
                }
                
                currentBg = videoUrl;
                currentBgType = bgType;
                applyBackground();
                
                const loadTime = (performance.now() - loadStart).toFixed(1);
                console.log(`âœ… è§†é¢‘åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${loadTime}ms`);
                markCheckpoint(`IndexedDBè§†é¢‘åŠ è½½: ${loadTime}ms`);
                return;
            }
        } catch (error) {
            console.warn('âŒ IndexedDBåŠ è½½å¤±è´¥:', error);
        }
        // IndexedDBåŠ è½½å¤±è´¥ï¼Œæ¸…é™¤æ ‡è®°
        localStorage.removeItem('startpage.bg');
        localStorage.removeItem('startpage.bgType');
        return;
    }
    
    // æƒ…å†µ2: base64æˆ–é¢„è®¾è§†é¢‘è·¯å¾„ - ç›´æ¥ä½¿ç”¨
    if (localBg) {
        currentBg = localBg;
        currentBgType = bgType;
        applyBackground();
        
        // å¦‚æœæ˜¯å¤§çš„base64ï¼Œåå°è¿ç§»åˆ°IndexedDBï¼ˆä¼˜åŒ–ä¸ºBlobå­˜å‚¨ï¼‰
        if (localBg.startsWith('data:') && localBg.length > 1024 * 1024) {
            setTimeout(async () => {
                try {
                    console.log('ğŸ”„ åå°è¿ç§»base64åˆ°Blobæ ¼å¼...');
                    // å°†base64è½¬ä¸ºBlob
                    const response = await fetch(localBg);
                    const blob = await response.blob();
                    
                    if (!db) await initIndexedDB();
                    await saveBackgroundToDB(blob, currentBgType);
                    localStorage.setItem('startpage.bg', 'INDEXED_DB_VIDEO');
                    console.log('âœ… è¿ç§»å®Œæˆï¼Œä¸‹æ¬¡åŠ è½½å°†æ›´å¿«');
                    markCheckpoint('è¿ç§»åˆ°IndexedDB Blob');
                } catch (e) {
                    console.warn('è¿ç§»å¤±è´¥:', e);
                }
            }, 3000);
        }
        
        markCheckpoint(localBg.startsWith('data:') ? 'æœ¬åœ°è§†é¢‘åŠ è½½' : 'é¢„è®¾è§†é¢‘åŠ è½½');
        return;
    }
}

// é«˜æ•ˆåº”ç”¨èƒŒæ™¯
function applyBackground() {
    const root = document.documentElement;
    if (currentBgType === 'video' && currentBg) {
        createVideoBackground(currentBg);
        root.style.setProperty('--bg', 'transparent');
        root.style.setProperty('--bg-image', 'none');
    } else if (currentBgType === 'image' && currentBg) {
        root.style.setProperty('--bg-image', `url(${currentBg})`);
        root.style.setProperty('--bg', 'none');
        root.style.setProperty('--bg-size', 'cover');
        root.style.setProperty('--bg-pos', 'center center');
    } else if (currentBgType === 'gradient' && currentBg) {
        root.style.setProperty('--bg', currentBg);
        root.style.setProperty('--bg-image', 'none');
    } else if (currentBgType === 'color' && currentBg) {
        root.style.setProperty('--bg', currentBg);
        root.style.setProperty('--bg-image', 'none');
    }
}

// æé€Ÿè§†é¢‘èƒŒæ™¯åˆ›å»º
function createVideoBackground(videoUrl) {
    const createStart = performance.now();
    
    let videoContainer = document.getElementById('videoBgContainer');
    let video = document.getElementById('videoBgPlayer');
    
    // å¤ç”¨å·²æœ‰è§†é¢‘å…ƒç´ ï¼ˆé¿å…é‡å»ºDOMï¼‰
    if (video && video.src === videoUrl && !video.paused) {
        video.style.opacity = '1';
        console.log('âš¡ å¤ç”¨ç°æœ‰è§†é¢‘ï¼Œè€—æ—¶: 0ms');
        return;
    }
    
    // åˆ›å»ºå®¹å™¨
    if (!videoContainer) {
        videoContainer = document.createElement('div');
        videoContainer.id = 'videoBgContainer';
        videoContainer.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden;pointer-events:none;';
        document.body.insertBefore(videoContainer, document.body.firstChild);
    }
    
    // åˆ›å»ºæˆ–å¤ç”¨è§†é¢‘å…ƒç´ 
    if (!video) {
        video = document.createElement('video');
        video.id = 'videoBgPlayer';
        video.autoplay = true;
        video.muted = true;
        video.loop = true;
        video.playsInline = true;
        
        // âš¡ æ€§èƒ½å…³é”®ï¼šé¢„åŠ è½½ä¼˜åŒ–
        video.preload = 'auto';  // æ”¹ä¸ºautoï¼ŒåŠ è½½å…ƒæ•°æ®å’Œéƒ¨åˆ†å†…å®¹
        video.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 0.3s;';
        
        // ç›‘å¬åŠ è½½å®Œæˆï¼Œæ·¡å…¥æ˜¾ç¤º
        video.addEventListener('loadeddata', () => {
            video.style.opacity = '1';
            const loadTime = (performance.now() - createStart).toFixed(1);
            console.log(`âœ… è§†é¢‘æ¸²æŸ“å®Œæˆï¼Œæ€»è€—æ—¶: ${loadTime}ms`);
        }, { once: true });
        
        videoContainer.appendChild(video);
    }
    
    // æ›´æ–°è§†é¢‘æº
    if (video.src !== videoUrl) {
        video.style.opacity = '0';  // å…ˆéšè—æ—§å†…å®¹
        video.src = videoUrl;
        
        // ç«‹å³æ’­æ”¾ï¼ˆä¸ç­‰å¾…å®Œå…¨åŠ è½½ï¼‰
        video.play().catch(() => {
            // éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾
            document.addEventListener('click', () => video.play(), { once: true });
        });
    }
    
    const setupTime = (performance.now() - createStart).toFixed(1);
    console.log(`âš¡ è§†é¢‘å…ƒç´ è®¾ç½®å®Œæˆï¼Œè€—æ—¶: ${setupTime}ms`);
}

// ç§»é™¤è§†é¢‘èƒŒæ™¯
function removeVideoBackground() {
    const videoContainer = document.getElementById('videoBgContainer');
    if (videoContainer) {
        const video = videoContainer.querySelector('video');
        if (video) {
            video.pause();
            video.src = '';
        }
        videoContainer.remove();
    }
}

// é¢„è®¾èƒŒæ™¯æ•°æ®
const presetBackgrounds = [
    { id: 'gradient1', name: 'å½©è™¹æ¸å˜', type: 'gradient', value: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
    { id: 'gradient2', name: 'æ—¥è½', type: 'gradient', value: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
    { id: 'gradient3', name: 'æµ·æ´‹', type: 'gradient', value: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
    { id: 'gradient4', name: 'æ£®æ—', type: 'gradient', value: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' },
    { id: 'solid1', name: 'æ·±è“', type: 'color', value: '#1e3a8a' },
    { id: 'solid2', name: 'æ·±ç´«', type: 'color', value: '#581c87' },
    { id: 'solid3', name: 'æ·±ç»¿', type: 'color', value: '#064e3b' },
    { id: 'solid4', name: 'æ·±çº¢', type: 'color', value: '#7f1d1d' }
];

// é¢„è®¾é«˜æ¸…åŠ¨æ€å£çº¸ï¼ˆè§†é¢‘èƒŒæ™¯ï¼‰
const presetVideos = [
    { id: 'video1', name: 'ä¸Šæ‰ç»˜æ¢¨è¡£', type: 'video', value: 'video/ä¸Šæ‰ç»˜æ¢¨è¡£.mp4', thumbnail: 'video/ä¸Šæ‰ç»˜æ¢¨è¡£.mp4' },
    { id: 'video_elaina1', name: 'ä¼Šè•¾å¨œ1', type: 'video', value: 'video/ä¼Šè•¾å¨œ1.mp4', thumbnail: 'video/ä¼Šè•¾å¨œ1.mp4' },
    { id: 'video_elaina2', name: 'ä¼Šè•¾å¨œ2', type: 'video', value: 'video/ä¼Šè•¾å¨œ2.mp4', thumbnail: 'video/ä¼Šè•¾å¨œ2.mp4' },
    { id: 'video_elaina3', name: 'ä¼Šè•¾å¨œ3', type: 'video', value: 'video/ä¼Šè•¾å¨œ3.mp4', thumbnail: 'video/ä¼Šè•¾å¨œ3.mp4' },
    { id: 'video_keqing', name: 'åˆ»æ™´', type: 'video', value: 'video/åˆ»æ™´.mp4', thumbnail: 'video/åˆ»æ™´.mp4' },
    { id: 'video_xi', name: 'å›', type: 'video', value: 'video/å›.mp4', thumbnail: 'video/å›.mp4' },
    { id: 'video3', name: 'å¿ƒæµ·', type: 'video', value: 'video/å¿ƒæµ·.mp4', thumbnail: 'video/å¿ƒæµ·.mp4' },
    { id: 'video_jiangnan', name: 'æ±Ÿå—çƒ§é…’', type: 'video', value: 'video/æ±Ÿå—çƒ§é…’.mp4', thumbnail: 'video/æ±Ÿå—çƒ§é…’.mp4' },
    { id: 'video4', name: 'è—¿è—¿', type: 'video', value: 'video/è—¿è—¿.mp4', thumbnail: 'video/è—¿è—¿.mp4' },
    { id: 'video5', name: 'èƒ¡æ¡ƒ', type: 'video', value: 'video/èƒ¡æ¡ƒ.mp4', thumbnail: 'video/èƒ¡æ¡ƒ.mp4' },
    { id: 'video_witch', name: 'é­”å¥³', type: 'video', value: 'video/é­”å¥³.mp4', thumbnail: 'video/é­”å¥³.mp4' },
    { id: 'video_luming', name: 'é¹¿é¸£', type: 'video', value: 'video/é¹¿é¸£.mp4', thumbnail: 'video/é¹¿é¸£.mp4' }
];

// æ–°å¢é¢„è®¾èƒŒæ™¯é¢œè‰²æ•°æ®
const presetColors = [
  { type: 'solid', color: '#FF5733' },
  { type: 'solid', color: '#33FF57' },
  { type: 'solid', color: '#3357FF' },
  { type: 'gradient', color: 'linear-gradient(135deg, #FF5733, #FFC300)' },
  { type: 'gradient', color: 'linear-gradient(135deg, #33FF57, #33FFF5)' },
  { type: 'gradient', color: 'linear-gradient(135deg, #3357FF, #8E44AD)' },
];

function openBackgroundDialog() {
    const dialog = document.getElementById('bgDialog');
    if (dialog) {
        initializeBackgroundDialog();
        dialog.showModal();
    } else {
        console.error('æ‰¾ä¸åˆ°èƒŒæ™¯å¯¹è¯æ¡† #bgDialog');
    }
}

function closeBackgroundDialog() {
    document.getElementById('bgDialog').close();
}

function initializeBackgroundDialog() {
    // åˆå§‹åŒ–æ ‡ç­¾é¡µ
    switchTab('presets');
    
    // ç”Ÿæˆé¢„è®¾èƒŒæ™¯
    generatePresetBackgrounds();
    
    // é‡ç½®è‡ªå®šä¹‰ä¸Šä¼ åŒºåŸŸ
    resetCustomUpload();
    
    // ç»‘å®šæ ‡ç­¾é¡µç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
}

// æ¸²æŸ“é¢„è®¾èƒŒæ™¯é¢œè‰²
function renderPresetColors() {
  const presetsGrid = document.getElementById('presetsGrid');
  presetsGrid.innerHTML = '';

  presetColors.forEach((preset) => {
    const div = document.createElement('div');
    div.className = `preset-item color ${preset.type}`;
    div.style.background = preset.color;
    div.setAttribute('tabindex', '0');
    div.addEventListener('click', () => {
      applyBackground(preset.color);
    });
    presetsGrid.appendChild(div);
  });
}

function switchTab(tabName) {
    // åˆ‡æ¢æ ‡ç­¾é¡µçŠ¶æ€
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®å’Œé¢æ¿
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    const activePanel = document.querySelector(`[data-panel="${tabName}"]`);
    
    if (activeBtn) activeBtn.classList.add('active');
    if (activePanel) activePanel.classList.add('active');
}

function generatePresetBackgrounds() {
    const grid = document.getElementById('presetsGrid');
    if (!grid) {
        console.error('æ‰¾ä¸åˆ°é¢„è®¾èƒŒæ™¯ç½‘æ ¼ #presetsGrid');
        return;
    }
    
    grid.innerHTML = '';
    
    // æ·»åŠ æ¸å˜å’Œçº¯è‰²é¢„è®¾
    presetBackgrounds.forEach(bg => {
        const item = document.createElement('div');
        item.className = 'preset-item';
        item.onclick = () => selectPresetBackground(bg);
        
        const preview = document.createElement('div');
        preview.className = 'preset-preview';
        if (bg.type === 'gradient') {
            preview.style.background = bg.value;
        } else {
            preview.style.backgroundColor = bg.value;
        }
        
        const name = document.createElement('div');
        name.className = 'preset-name';
        name.textContent = bg.name;
        
        item.appendChild(preview);
        item.appendChild(name);
        grid.appendChild(item);
    });
    
    // æ·»åŠ è§†é¢‘é¢„è®¾
    presetVideos.forEach(bg => {
        const item = document.createElement('div');
        item.className = 'preset-item video-preset';
        item.onclick = () => selectPresetBackground(bg);
        
        const preview = document.createElement('div');
        preview.className = 'preset-preview video-preview';
        preview.style.backgroundImage = `url(${bg.thumbnail})`;
        preview.style.backgroundSize = 'cover';
        preview.style.backgroundPosition = 'center';
        
        // æ·»åŠ æ’­æ”¾å›¾æ ‡
        const playIcon = document.createElement('div');
        playIcon.className = 'play-icon';
        playIcon.innerHTML = `
            <svg width="48" height="48" viewBox="0 0 24 24" fill="white" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                <path d="M8 5v14l11-7z"/>
            </svg>
        `;
        preview.appendChild(playIcon);
        
        const name = document.createElement('div');
        name.className = 'preset-name';
        name.textContent = `ğŸ¬ ${bg.name}`;
        
        item.appendChild(preview);
        item.appendChild(name);
        grid.appendChild(item);
    });
}

function selectPresetBackground(bg) {
    // æ£€æŸ¥æ˜¯å¦ä¼šè¦†ç›–è‡ªå®šä¹‰ä¸Šä¼ çš„è§†é¢‘
    const currentBgValue = localStorage.getItem('startpage.bg');
    if (currentBgValue === 'INDEXED_DB_VIDEO' && bg.type === 'video') {
        const confirmed = confirm('å½“å‰æœ‰è‡ªå®šä¹‰ä¸Šä¼ çš„è§†é¢‘èƒŒæ™¯ï¼Œåˆ‡æ¢åˆ°é¢„è®¾è§†é¢‘ä¼šä¸¢å¤±ã€‚ç¡®å®šè¦åˆ‡æ¢å—ï¼Ÿ');
        if (!confirmed) {
            return;
        }
    }
    
    // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.preset-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // æ·»åŠ é€‰ä¸­çŠ¶æ€
    event.currentTarget.classList.add('selected');
    
    // åº”ç”¨èƒŒæ™¯
    currentBg = bg.value;
    currentBgType = bg.type;
    applyBackground();
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('startpage.bg', currentBg);
    localStorage.setItem('startpage.bgType', currentBgType);
    
    console.log('å·²åº”ç”¨èƒŒæ™¯:', bg.name, 'è·¯å¾„:', currentBg);
    
    showToast(`å·²åº”ç”¨${bg.name}èƒŒæ™¯`);
    closeBackgroundDialog();
    setTimeout(() => location.reload(), 500);
}

function resetCustomUpload() {
    const fileInput = document.getElementById('bgFileInput');
    const urlInput = document.getElementById('bgUrlInput');
    
    if (fileInput) fileInput.value = '';
    if (urlInput) urlInput.value = '';
}

function resetBackground() {
    currentBg = '';
    currentBgType = 'color';
    applyBackground();
    localStorage.removeItem('startpage.bg');
    localStorage.removeItem('startpage.bgType');
    showToast('èƒŒæ™¯å·²é‡ç½®');
    closeBackgroundDialog();
    setTimeout(() => location.reload(), 500);
}

function applyBackground(color) {
  document.body.style.background = color;
}

function applyBackground() {
    const root = document.documentElement;
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡æ›´æ–°CSSå˜é‡
    const updates = {};
    let needsVideoCleanup = true;
    
    if (currentBgType === 'video' && currentBg) {
        console.log('åº”ç”¨è§†é¢‘èƒŒæ™¯');
        createVideoBackground(currentBg);
        updates['--bg'] = 'transparent';
        updates['--bg-image'] = 'none';
        needsVideoCleanup = false;
    } else if (currentBgType === 'image' && currentBg) {
        console.log('åº”ç”¨å›¾ç‰‡èƒŒæ™¯');
        updates['--bg-image'] = `url(${currentBg})`;
        updates['--bg'] = 'none';
        updates['--bg-size'] = 'cover';
        updates['--bg-pos'] = 'center center';
    } else if (currentBgType === 'gradient' && currentBg) {
        console.log('åº”ç”¨æ¸å˜èƒŒæ™¯');
        updates['--bg'] = currentBg;
        updates['--bg-image'] = 'none';
    } else if (currentBgType === 'color' && currentBg) {
        console.log('åº”ç”¨çº¯è‰²èƒŒæ™¯');
        updates['--bg'] = currentBg;
        updates['--bg-image'] = 'none';
    } else {
        console.log('é‡ç½®èƒŒæ™¯');
        // ç§»é™¤æ‰€æœ‰èƒŒæ™¯ç›¸å…³CSSå˜é‡
        root.style.removeProperty('--bg-image');
        root.style.removeProperty('--bg');
        root.style.removeProperty('--bg-size');
        root.style.removeProperty('--bg-pos');
    }
    
    // æ‰¹é‡åº”ç”¨CSSå˜é‡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    if (Object.keys(updates).length > 0) {
        requestAnimationFrame(() => {
            for (const [key, value] of Object.entries(updates)) {
                root.style.setProperty(key, value);
            }
        });
    }
    
    // æ¸…ç†è§†é¢‘èƒŒæ™¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (needsVideoCleanup) {
        removeVideoBackground();
    }
}

// åˆ›å»ºè§†é¢‘èƒŒæ™¯ï¼ˆæé€Ÿä¼˜åŒ–ç‰ˆï¼‰


// ç§»é™¤è§†é¢‘èƒŒæ™¯
function removeVideoBackground() {
    const videoContainer = document.getElementById('videoBgContainer');
    if (videoContainer) {
        const video = videoContainer.querySelector('video');
        if (video) {
            video.pause();
            video.src = '';
        }
        videoContainer.remove();
    }
}

// ä¼˜åŒ–çš„å›¾ç‰‡å‹ç¼©å‡½æ•° - ä½¿ç”¨å…ˆè¿›ç®—æ³•ä¿æŒæœ€ä½³ç”»è´¨
function compressImage(file, options = {}) {
    return new Promise((resolve, reject) => {
        const {
            maxWidth = 2560,
            maxHeight = 1440,
            quality = 0.92,
            mimeType = 'image/jpeg',
            targetSize = null
        } = options;

        const img = new Image();
        
        img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
        
        img.onload = function() {
            try {
                // è®¡ç®—æ–°çš„å°ºå¯¸ï¼Œä¿æŒå®½é«˜æ¯”
                let { width, height } = img;
                let scale = 1;
                
                if (width > maxWidth || height > maxHeight) {
                    const widthScale = maxWidth / width;
                    const heightScale = maxHeight / height;
                    scale = Math.min(widthScale, heightScale);
                    width = Math.round(width * scale);
                    height = Math.round(height * scale);
                }
                
                console.log(`å›¾ç‰‡å°ºå¯¸: ${img.width}x${img.height} â†’ ${width}x${height} (ç¼©æ”¾: ${(scale * 100).toFixed(1)}%)`);
                
                // ä½¿ç”¨å…ˆè¿›çš„ç¼©æ”¾ç®—æ³•
                let finalCanvas;
                if (scale < 1) {
                    // éœ€è¦ç¼©å°å›¾ç‰‡ï¼Œä½¿ç”¨é«˜è´¨é‡çš„åˆ†æ­¥ç¼©æ”¾ç®—æ³•
                    finalCanvas = downscaleImage(img, width, height);
                } else {
                    // ä¸éœ€è¦ç¼©æ”¾æˆ–æ”¾å¤§ï¼Œç›´æ¥ç»˜åˆ¶
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { 
                        alpha: false,
                        desynchronized: true 
                    });
                    canvas.width = width;
                    canvas.height = height;
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    finalCanvas = canvas;
                }
                
                // åº”ç”¨é”åŒ–æ»¤é•œæå‡æ¸…æ™°åº¦
                sharpenImage(finalCanvas);
                
                // å¦‚æœæŒ‡å®šäº†ç›®æ ‡å¤§å°ï¼Œä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æœ€ä½³è´¨é‡
                if (targetSize) {
                    findOptimalQuality(finalCanvas, mimeType, targetSize, 0.75, 0.98)
                        .then(resolve)
                        .catch(() => {
                            finalCanvas.toBlob(resolve, mimeType, quality);
                        });
                } else {
                    finalCanvas.toBlob(resolve, mimeType, quality);
                }
                
                // é‡Šæ”¾èµ„æº
                URL.revokeObjectURL(img.src);
                
            } catch (error) {
                reject(error);
            }
        };
        
        if (file instanceof Blob) {
            img.src = URL.createObjectURL(file);
        } else {
            reject(new Error('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹'));
        }
    });
}

// é«˜è´¨é‡é™é‡‡æ ·ç®—æ³•ï¼ˆHermiteé‡é‡‡æ ·ï¼‰
function downscaleImage(img, targetWidth, targetHeight) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    
    let currentWidth = img.width;
    let currentHeight = img.height;
    
    // å¦‚æœç¼©å°æ¯”ä¾‹å¤§äº50%ï¼Œä½¿ç”¨åˆ†æ­¥ç¼©æ”¾
    const scaleRatio = Math.min(targetWidth / currentWidth, targetHeight / currentHeight);
    
    if (scaleRatio < 0.5) {
        console.log('ä½¿ç”¨åˆ†æ­¥ç¼©æ”¾ç®—æ³•æå‡æ¸…æ™°åº¦');
        
        // ç¬¬ä¸€æ­¥ï¼šç¼©å°åˆ°2å€ç›®æ ‡å°ºå¯¸
        let tempCanvas = document.createElement('canvas');
        let tempCtx = tempCanvas.getContext('2d', { alpha: false });
        
        // è®¡ç®—ä¸­é—´å°ºå¯¸
        const steps = [];
        let ratio = scaleRatio;
        while (ratio < 0.5) {
            steps.push(0.5);
            ratio = ratio / 0.5;
        }
        steps.push(ratio);
        
        console.log(`åˆ†${steps.length}æ­¥ç¼©æ”¾:`, steps.map(s => (s * 100).toFixed(1) + '%').join(' â†’ '));
        
        let sourceCanvas = createCanvasFromImage(img);
        
        for (let i = 0; i < steps.length; i++) {
            const stepRatio = steps[i];
            const newWidth = Math.round(currentWidth * stepRatio);
            const newHeight = Math.round(currentHeight * stepRatio);
            
            tempCanvas.width = newWidth;
            tempCanvas.height = newHeight;
            tempCtx.imageSmoothingEnabled = true;
            tempCtx.imageSmoothingQuality = 'high';
            
            if (i === 0) {
                tempCtx.drawImage(img, 0, 0, newWidth, newHeight);
            } else {
                tempCtx.drawImage(sourceCanvas, 0, 0, newWidth, newHeight);
            }
            
            currentWidth = newWidth;
            currentHeight = newHeight;
            
            // äº¤æ¢ç”»å¸ƒ
            if (i < steps.length - 1) {
                sourceCanvas = tempCanvas;
                tempCanvas = document.createElement('canvas');
                tempCtx = tempCanvas.getContext('2d', { alpha: false });
            }
        }
        
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(tempCanvas, 0, 0, targetWidth, targetHeight);
        
    } else {
        // ç¼©å°æ¯”ä¾‹è¾ƒå°ï¼Œç›´æ¥ç¼©æ”¾
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
    }
    
    return canvas;
}

// åˆ›å»ºç”»å¸ƒä»å›¾ç‰‡
function createCanvasFromImage(img) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
    return canvas;
}

// é”åŒ–æ»¤é•œ - æå‡å›¾åƒæ¸…æ™°åº¦
function sharpenImage(canvas) {
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // è·å–å›¾åƒæ•°æ®
    const imageData = ctx.getImageData(0, 0, width, height);
    const data = imageData.data;
    
    // åˆ›å»ºè¾“å‡ºæ•°æ®
    const outputData = new Uint8ClampedArray(data);
    
    // é”åŒ–å·ç§¯æ ¸ (é€‚åº¦é”åŒ–ï¼Œé¿å…è¿‡åº¦)
    const kernel = [
        0,  -0.15,  0,
        -0.15,  1.6,  -0.15,
        0,  -0.15,  0
    ];
    
    console.log('åº”ç”¨é”åŒ–æ»¤é•œæå‡æ¸…æ™°åº¦');
    
    // åº”ç”¨å·ç§¯
    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            const idx = (y * width + x) * 4;
            
            for (let c = 0; c < 3; c++) { // RGBé€šé“
                let sum = 0;
                
                // 3x3å·ç§¯
                for (let ky = -1; ky <= 1; ky++) {
                    for (let kx = -1; kx <= 1; kx++) {
                        const pixelIdx = ((y + ky) * width + (x + kx)) * 4 + c;
                        const kernelIdx = (ky + 1) * 3 + (kx + 1);
                        sum += data[pixelIdx] * kernel[kernelIdx];
                    }
                }
                
                outputData[idx + c] = Math.max(0, Math.min(255, sum));
            }
            
            // ä¿æŒAlphaé€šé“ä¸å˜
            outputData[idx + 3] = data[idx + 3];
        }
    }
    
    // å°†é”åŒ–åçš„æ•°æ®å†™å›ç”»å¸ƒ
    const outputImageData = new ImageData(outputData, width, height);
    ctx.putImageData(outputImageData, 0, 0);
}

// äºŒåˆ†æŸ¥æ‰¾æœ€ä½³å‹ç¼©è´¨é‡
function findOptimalQuality(canvas, mimeType, targetSize, minQuality = 0.75, maxQuality = 0.98) {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 12; // å¢åŠ å°è¯•æ¬¡æ•°ä»¥è·å¾—æœ€ç²¾ç¡®çš„ç»“æœ
        
        function tryQuality(quality) {
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    resolve({ blob, size: blob.size, quality });
                }, mimeType, quality);
            });
        }
        
        async function binarySearch() {
            let low = minQuality;
            let high = maxQuality;
            let bestBlob = null;
            let bestQuality = minQuality;
            
            // å…ˆå°è¯•æœ€é«˜è´¨é‡
            const highResult = await tryQuality(maxQuality);
            const highSizeKB = (highResult.size / 1024).toFixed(0);
            const targetSizeKB = (targetSize / 1024).toFixed(0);
            console.log(`æœ€é«˜è´¨é‡æµ‹è¯•: è´¨é‡=${maxQuality.toFixed(2)}, å¤§å°=${highSizeKB}KB, ç›®æ ‡=${targetSizeKB}KB`);
            
            if (highResult.size <= targetSize) {
                console.log(`âœ“ æœ€é«˜è´¨é‡(${maxQuality})æ»¡è¶³è¦æ±‚ï¼Œç›´æ¥ä½¿ç”¨`);
                resolve(highResult.blob);
                return;
            }
            
            // äºŒåˆ†æŸ¥æ‰¾
            while (attempts < maxAttempts && high - low > 0.015) {
                attempts++;
                const mid = (low + high) / 2;
                const result = await tryQuality(mid);
                const sizeKB = (result.size / 1024).toFixed(0);
                
                console.log(`å°è¯• ${attempts}/${maxAttempts}: è´¨é‡=${mid.toFixed(3)}, å¤§å°=${sizeKB}KB`);
                
                if (result.size <= targetSize) {
                    bestBlob = result.blob;
                    bestQuality = mid;
                    low = mid; // å°è¯•æ›´é«˜è´¨é‡
                } else {
                    high = mid; // é™ä½è´¨é‡
                }
            }
            
            if (bestBlob) {
                const finalSizeKB = (bestBlob.size / 1024).toFixed(0);
                console.log(`âœ“ æ‰¾åˆ°æœ€ä½³è´¨é‡: ${bestQuality.toFixed(3)}, æœ€ç»ˆå¤§å°: ${finalSizeKB}KB`);
                resolve(bestBlob);
            } else {
                console.log(`ä½¿ç”¨æœ€ä½è´¨é‡: ${minQuality}`);
                const result = await tryQuality(minQuality);
                resolve(result.blob);
            }
        }
        
        binarySearch().catch(reject);
    });
}

// æ™ºèƒ½å‹ç¼© - æ ¹æ®å›¾ç‰‡ç‰¹å¾è‡ªåŠ¨é€‰æ‹©æœ€ä½³å‹ç¼©ç­–ç•¥
function smartCompress(file) {
    return new Promise(async (resolve, reject) => {
        try {
            const fileSizeMB = file.size / 1024 / 1024;
            const targetSizeMB = 2; // ç›®æ ‡2MB
            const targetSizeBytes = targetSizeMB * 1024 * 1024;
            
            console.log(`åŸå§‹æ–‡ä»¶å¤§å°: ${fileSizeMB.toFixed(2)}MB`);
            
            let compressOptions;
            
            // å¦‚æœæ–‡ä»¶å·²ç»å°äº2MBï¼Œåªè¿›è¡Œè½»åº¦ä¼˜åŒ–å¹¶é”åŒ–ä»¥æå‡ç”»è´¨
            if (file.size < targetSizeBytes) {
                compressOptions = {
                    maxWidth: 2560,
                    maxHeight: 1440,
                    quality: 0.97,     // æé«˜è´¨é‡
                    mimeType: 'image/jpeg'
                };
                console.log('æ–‡ä»¶å°äº2MBï¼Œä½¿ç”¨æé«˜ç”»è´¨æ¨¡å¼(0.97) + é”åŒ–');
            } 
            // æ–‡ä»¶åœ¨2-4MBä¹‹é—´
            else if (fileSizeMB < 4) {
                compressOptions = {
                    maxWidth: 2560,
                    maxHeight: 1440,
                    quality: 0.95,
                    targetSize: targetSizeBytes,
                    mimeType: 'image/jpeg'
                };
                console.log('æ–‡ä»¶2-4MBï¼Œä½¿ç”¨è¶…é«˜ç”»è´¨(0.95)æ¨¡å¼ + é”åŒ–');
            }
            // æ–‡ä»¶åœ¨4-8MBä¹‹é—´
            else if (fileSizeMB < 8) {
                compressOptions = {
                    maxWidth: 2560,
                    maxHeight: 1440,
                    targetSize: targetSizeBytes,
                    mimeType: 'image/jpeg'
                };
                console.log('æ–‡ä»¶4-8MBï¼Œè‡ªåŠ¨ä¼˜åŒ–ç”»è´¨(æœ€é«˜0.98) + é”åŒ–');
            }
            // è¶…å¤§æ–‡ä»¶
            else {
                compressOptions = {
                    maxWidth: 2560,
                    maxHeight: 1440,
                    targetSize: targetSizeBytes,
                    mimeType: 'image/jpeg'
                };
                console.log('è¶…å¤§æ–‡ä»¶ï¼Œæ™ºèƒ½å‹ç¼©åˆ°2MBä»¥å†… + é”åŒ–');
            }
            
            console.log('å‹ç¼©é…ç½®:', compressOptions);
            const compressedBlob = await compressImage(file, compressOptions);
            
            if (compressedBlob) {
                const compressedSizeMB = compressedBlob.size / 1024 / 1024;
                const ratio = ((1 - compressedSizeMB / fileSizeMB) * 100).toFixed(1);
                console.log(`âœ“ å‹ç¼©å®Œæˆ: ${fileSizeMB.toFixed(2)}MB â†’ ${compressedSizeMB.toFixed(2)}MB (å‹ç¼©${ratio}%)`);
                
                if (compressedBlob.size > targetSizeBytes) {
                    const overMB = ((compressedBlob.size - targetSizeBytes) / 1024 / 1024).toFixed(2);
                    console.warn(`âš  å‹ç¼©åä»è¶…è¿‡ç›®æ ‡${overMB}MBï¼Œå¯èƒ½æ— æ³•ä¿å­˜åˆ°localStorage`);
                }
                
                resolve(compressedBlob);
            } else {
                reject(new Error('å‹ç¼©å¤±è´¥'));
            }
            
        } catch (error) {
            console.error('æ™ºèƒ½å‹ç¼©å‡ºé”™:', error);
            reject(error);
        }
    });
}

function handleFileUpload(file) {
    console.log('å¤„ç†æ–‡ä»¶ä¸Šä¼ :', file);
    
    if (!file) {
        console.error('æ²¡æœ‰æ–‡ä»¶');
        showToast('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
    }
    
    // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯è§†é¢‘
    const isImage = file.type.startsWith('image/');
    const isVideo = file.type.startsWith('video/');
    
    if (!isImage && !isVideo) {
        console.error('æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ:', file.type);
        showToast('è¯·é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶');
        return;
    }
    
    if (isVideo) {
        // å¤„ç†è§†é¢‘æ–‡ä»¶
        handleVideoUpload(file);
    } else {
        // å¤„ç†å›¾ç‰‡æ–‡ä»¶
        handleImageUpload(file);
    }
}

function handleVideoUpload(file) {
    console.log('å¤„ç†è§†é¢‘ä¸Šä¼ :', file.type, 'å¤§å°:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
    
    const fileSizeMB = file.size / 1024 / 1024;
    
    // è¶…è¿‡10MBéœ€è¦ä¼˜åŒ–
    if (fileSizeMB > 10) {
        showToast('è§†é¢‘è¾ƒå¤§ï¼Œæ­£åœ¨ä¼˜åŒ–å¤„ç†...');
        optimizeVideo(file).then(optimizedBlob => {
            if (optimizedBlob) {
                const optimizedSizeMB = optimizedBlob.size / 1024 / 1024;
                console.log('è§†é¢‘ä¼˜åŒ–å®Œæˆï¼Œä¼˜åŒ–åå¤§å°:', optimizedSizeMB.toFixed(2) + 'MB');
                processVideoFile(optimizedBlob);
            } else {
                // ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸæ–‡ä»¶
                console.warn('è§†é¢‘ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸæ–‡ä»¶');
                showToast('æ­£åœ¨åŠ è½½åŸå§‹è§†é¢‘...');
                processVideoFile(file);
            }
        }).catch(error => {
            console.error('è§†é¢‘ä¼˜åŒ–å‡ºé”™:', error);
            showToast('æ­£åœ¨åŠ è½½åŸå§‹è§†é¢‘...');
            processVideoFile(file);
        });
    } else {
        // 10MBä»¥ä¸‹ç›´æ¥åŠ è½½
        showToast('æ­£åœ¨åŠ è½½è§†é¢‘...');
        processVideoFile(file);
    }
}

// ä¼˜åŒ–è§†é¢‘æ–‡ä»¶
function optimizeVideo(file) {
    return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        video.preload = 'metadata';
        video.muted = true;
        
        video.onloadedmetadata = function() {
            // è·å–è§†é¢‘å°ºå¯¸
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            const videoDuration = video.duration;
            
            console.log('è§†é¢‘ä¿¡æ¯:', {
                å®½åº¦: videoWidth,
                é«˜åº¦: videoHeight,
                æ—¶é•¿: videoDuration.toFixed(2) + 's'
            });
            
            // è®¡ç®—ç›®æ ‡å°ºå¯¸ï¼ˆä¿æŒå®½é«˜æ¯”ï¼Œæœ€å¤§1920x1080ï¼‰
            let targetWidth = videoWidth;
            let targetHeight = videoHeight;
            const maxWidth = 1920;
            const maxHeight = 1080;
            
            if (videoWidth > maxWidth || videoHeight > maxHeight) {
                const widthRatio = maxWidth / videoWidth;
                const heightRatio = maxHeight / videoHeight;
                const ratio = Math.min(widthRatio, heightRatio);
                
                targetWidth = Math.round(videoWidth * ratio);
                targetHeight = Math.round(videoHeight * ratio);
                
                // ç¡®ä¿æ˜¯å¶æ•°ï¼ˆè§†é¢‘ç¼–ç è¦æ±‚ï¼‰
                targetWidth = targetWidth - (targetWidth % 2);
                targetHeight = targetHeight - (targetHeight % 2);
            }
            
            console.log('ç›®æ ‡å°ºå¯¸:', targetWidth + 'x' + targetHeight);
            
            // è®¾ç½®canvaså°ºå¯¸
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            
            // ç”±äºæµè§ˆå™¨æ— æ³•ç›´æ¥å‹ç¼©è§†é¢‘ï¼Œæˆ‘ä»¬é‡‡å–é™ä½åˆ†è¾¨ç‡çš„ç­–ç•¥
            // æ•è·è§†é¢‘ç¬¬ä¸€å¸§ä½œä¸ºé¢„è§ˆ
            video.currentTime = 0;
        };
        
        video.onseeked = function() {
            // ç»˜åˆ¶ç¼©å°çš„è§†é¢‘å¸§
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // å¦‚æœåŸè§†é¢‘è¿‡å¤§ï¼Œæˆ‘ä»¬åªèƒ½ä½¿ç”¨é™ä½åˆ†è¾¨ç‡çš„æ–¹å¼
            // ä½†è¿™ä¼šå¯¼è‡´é™æ€å›¾ï¼Œæ‰€ä»¥å¯¹äºè§†é¢‘æˆ‘ä»¬é€‰æ‹©ç›´æ¥ä½¿ç”¨åŸæ–‡ä»¶ä½†è­¦å‘Šç”¨æˆ·
            console.log('ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œæ— æ³•çœŸæ­£å‹ç¼©è§†é¢‘ï¼Œä½¿ç”¨åŸæ–‡ä»¶');
            resolve(null); // è¿”å›nullè¡¨ç¤ºä½¿ç”¨åŸæ–‡ä»¶
        };
        
        video.onerror = function(e) {
            console.error('è§†é¢‘åŠ è½½å¤±è´¥:', e);
            reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
        };
        
        // ä½¿ç”¨URL.createObjectURLè€Œä¸æ˜¯FileReaderæé«˜æ€§èƒ½
        const videoUrl = URL.createObjectURL(file);
        video.src = videoUrl;
    });
}

// å¤„ç†è§†é¢‘æ–‡ä»¶ï¼ˆç›´æ¥ä¿å­˜Blobåˆ°IndexedDBï¼Œé¿å…base64ç¼–ç å¼€é”€ï¼‰
async function processVideoFile(file) {
    console.log('ğŸ¬ å¼€å§‹å¤„ç†è§†é¢‘æ–‡ä»¶:', file.name, 'å¤§å°:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
    
    try {
        // âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šç›´æ¥ä½¿ç”¨Blobï¼Œä¸è½¬base64ï¼ˆèŠ‚çœ30-40%ç¼–ç æ—¶é—´ï¼‰
        const blobUrl = URL.createObjectURL(file);
        
        // ç«‹å³æ˜¾ç¤ºè§†é¢‘ï¼ˆæ— éœ€ç­‰å¾…ä¿å­˜ï¼‰
        currentBg = blobUrl;
        currentBgType = 'video';
        applyBackground();
        console.log('âœ… è§†é¢‘èƒŒæ™¯å·²åº”ç”¨ï¼ˆBlob URLï¼‰');
        
        // åå°ä¿å­˜åˆ°IndexedDBï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡UIï¼‰
        showToast('æ­£åœ¨ä¿å­˜è§†é¢‘èƒŒæ™¯...');
        
        // ç¡®ä¿IndexedDBå·²åˆå§‹åŒ–
        if (!db) {
            console.log('â³ ç­‰å¾…IndexedDBåˆå§‹åŒ–...');
            await initIndexedDB();
            console.log('âœ… IndexedDBåˆå§‹åŒ–å®Œæˆ');
        }
        
        console.log('â³ å¼€å§‹ä¿å­˜Blobåˆ°IndexedDB...');
        // ä¿å­˜åŸå§‹Blobï¼ˆæ¯”base64å°30-40%ï¼‰
        await saveBackgroundToDB(file, currentBgType);
        console.log('âœ… IndexedDBä¿å­˜æˆåŠŸ');
        
        // ğŸ”´ å…³é”®ä¿®å¤ï¼šä¿å­˜IndexedDBæ ‡è®°åˆ°localStorage
        localStorage.setItem('startpage.bgType', currentBgType);
        localStorage.setItem('startpage.bg', 'INDEXED_DB_VIDEO');
        console.log('âœ… localStorageæ ‡è®°å·²è®¾ç½®: INDEXED_DB_VIDEO');
        
        showToast('âœ… è§†é¢‘èƒŒæ™¯å·²åº”ç”¨å¹¶æ°¸ä¹…ä¿å­˜');
        console.log('âœ… å®Œæ•´ä¿å­˜æµç¨‹æˆåŠŸï¼');
        setTimeout(() => location.reload(), 500);
        
    } catch (error) {
        console.error('âŒ è§†é¢‘å¤„ç†å¤±è´¥:', error);
        showToast('è§†é¢‘èƒŒæ™¯åº”ç”¨å¤±è´¥: ' + error.message);
    }
}

function handleImageUpload(file) {
    console.log('åŸå§‹æ–‡ä»¶:', file.type, 'å¤§å°:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
    
    // æ˜¾ç¤ºå¤„ç†ä¸­çš„æç¤º
    const fileSizeMB = file.size / 1024 / 1024;
    if (fileSizeMB > 10) {
        showToast('å›¾ç‰‡è¾ƒå¤§ï¼Œæ­£åœ¨æ™ºèƒ½å‹ç¼©ï¼Œè¯·ç¨å€™...');
    } else {
        showToast('æ­£åœ¨ä¼˜åŒ–å›¾ç‰‡è´¨é‡...');
    }
    
    // æ‰€æœ‰å›¾ç‰‡éƒ½ä½¿ç”¨æ™ºèƒ½å‹ç¼©ä»¥ä¿è¯åœ¨2MBä»¥ä¸‹ä¸”è´¨é‡æœ€ä¼˜
    smartCompress(file).then(compressedBlob => {
        if (compressedBlob) {
            const compressedSizeMB = compressedBlob.size / 1024 / 1024;
            console.log('å¤„ç†å®Œæˆï¼Œæœ€ç»ˆå¤§å°:', compressedSizeMB.toFixed(2) + 'MB');
            
            if (compressedSizeMB > 2) {
                showToast(`å›¾ç‰‡å·²ä¼˜åŒ–ä½†ä»è¾ƒå¤§(${compressedSizeMB.toFixed(1)}MB)ï¼Œå¯èƒ½æ— æ³•ä¿å­˜`);
            }
            
            processImageFile(compressedBlob);
        } else {
            showToast('å›¾ç‰‡å¤„ç†å¤±è´¥');
        }
    }).catch(error => {
        console.error('å¤„ç†å‡ºé”™:', error);
        showToast('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–å›¾ç‰‡');
    });
}

function processImageFile(file) {
    const reader = new FileReader();
    reader.onload = async function(e) {
        const imageData = e.target.result;
        const dataSizeMB = imageData.length / 1024 / 1024;
        console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œbase64å¤§å°:', dataSizeMB.toFixed(2) + 'MB');
        
        try {
            // å…ˆä¸´æ—¶åº”ç”¨èƒŒæ™¯
            currentBg = imageData;
            currentBgType = 'image';
            applyBackground();
            
            // ä¼˜å…ˆå°è¯•ä¿å­˜åˆ°localStorageï¼ˆæ›´å¿«ï¼‰
            try {
                localStorage.setItem('startpage.bg', currentBg);
                localStorage.setItem('startpage.bgType', currentBgType);
                
                // åŒæ—¶å¼‚æ­¥å¤‡ä»½åˆ°IndexedDB
                saveBackgroundToDB(currentBg, currentBgType).catch(err => {
                    console.warn('å¤‡ä»½åˆ°IndexedDBå¤±è´¥:', err);
                });
                closeBackgroundDialog();
                showToast('è‡ªå®šä¹‰èƒŒæ™¯å·²åº”ç”¨å¹¶ä¿å­˜ âœ“');
                console.log('èƒŒæ™¯å·²æˆåŠŸä¿å­˜åˆ°localStorage');
                setTimeout(() => location.reload(), 500);
                
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.warn('localStorageé…é¢è¶…å‡ºï¼Œå°è¯•ä¿å­˜åˆ°IndexedDB...');
                    
                    // localStorageæ»¡äº†ï¼Œå°è¯•IndexedDB
                    try {
                        await saveBackgroundToDB(currentBg, currentBgType);
                        closeBackgroundDialog();
                        showToast('èƒŒæ™¯å·²åº”ç”¨å¹¶ä¿å­˜åˆ°IndexedDB âœ“');
                        setTimeout(() => location.reload(), 500);
                    } catch (dbError) {
                        console.error('IndexedDBä¹Ÿä¿å­˜å¤±è´¥ï¼Œå°è¯•æ›´é«˜å‹ç¼©ç‡...');
                        
                        // å¦‚æœè¿˜æ˜¯å¤ªå¤§ï¼Œå°è¯•æ›´æ¿€è¿›çš„å‹ç¼©
                        if (file instanceof Blob) {
                            const originalFile = new File([file], 'compressed.jpg', { type: 'image/jpeg' });
                            compressImage(originalFile, {
                                maxWidth: 1280,
                                maxHeight: 720,
                                targetSize: 800 * 1024, // ç›®æ ‡800KB
                                quality: 0.75
                            }).then(smallerBlob => {
                                if (smallerBlob) {
                                    console.log('äºŒæ¬¡å‹ç¼©å®Œæˆ:', (smallerBlob.size / 1024).toFixed(0) + 'KB');
                                    processImageFile(smallerBlob);
                                } else {
                                    showToast('å›¾ç‰‡è¿‡å¤§ï¼Œä»…ä¸´æ—¶åº”ç”¨');
                                    closeBackgroundDialog();
                                }
                            }).catch(() => {
                                showToast('å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œä»…ä¸´æ—¶åº”ç”¨');
                                closeBackgroundDialog();
                            });
                        } else {
                            showToast('å›¾ç‰‡å·²åº”ç”¨ï¼ˆæ— æ³•æ°¸ä¹…ä¿å­˜ï¼‰');
                            closeBackgroundDialog();
                        }
                    }
                } else {
                    throw error;
                }
            }
            
        } catch (error) {
            console.error('ä¿å­˜èƒŒæ™¯å¤±è´¥:', error);
            showToast('ä¿å­˜èƒŒæ™¯å¤±è´¥: ' + error.message);
        }
    };
    
    reader.onerror = function(e) {
        console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', e);
        showToast('æ–‡ä»¶è¯»å–å¤±è´¥');
    };
    
    reader.readAsDataURL(file);
}

function handleUrlBackground() {
    const urlInput = document.getElementById('bgUrlInput');
    const url = urlInput.value.trim();
    
    if (!url) {
        showToast('è¯·è¾“å…¥å›¾ç‰‡æˆ–è§†é¢‘URL');
        return;
    }
    
    // ç®€å•éªŒè¯URLæ ¼å¼
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„HTTPæˆ–HTTPSé“¾æ¥');
        return;
    }
    
    try {
        // åˆ¤æ–­æ˜¯è§†é¢‘è¿˜æ˜¯å›¾ç‰‡
        const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov'];
        const isVideo = videoExtensions.some(ext => url.toLowerCase().includes(ext));
        
        currentBg = url;
        currentBgType = isVideo ? 'video' : 'image';
        applyBackground();
        
        // URLèƒŒæ™¯è¾ƒå°ï¼Œä¿å­˜åˆ°localStorageå³å¯
        // åŒæ—¶ä¹Ÿä¿å­˜åˆ°IndexedDBä½œä¸ºå¤‡ä»½
        localStorage.setItem('startpage.bg', currentBg);
        localStorage.setItem('startpage.bgType', currentBgType);
        
        // å¼‚æ­¥ä¿å­˜åˆ°IndexedDBï¼ˆä¸ç­‰å¾…ï¼‰
        saveBackgroundToDB(currentBg, currentBgType).catch(err => {
            console.warn('ä¿å­˜åˆ°IndexedDBå¤±è´¥ï¼ˆURLèƒŒæ™¯å·²åœ¨localStorageï¼‰:', err);
        closeBackgroundDialog();
        showToast(isVideo ? 'è§†é¢‘èƒŒæ™¯å·²åº”ç”¨å¹¶ä¿å­˜ âœ“' : 'èƒŒæ™¯å·²åº”ç”¨å¹¶ä¿å­˜ âœ“');
        console.log('URLèƒŒæ™¯å·²ä¿å­˜:', url);
        setTimeout(() => location.reload(), 500);
        });
    } catch (error) {
        console.error('ä¿å­˜URLèƒŒæ™¯å¤±è´¥:', error);
        showToast('åº”ç”¨èƒŒæ™¯å¤±è´¥: ' + error.message);
    }
}

// æ‹–æ‹½åŠŸèƒ½
function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    if (!uploadArea) return;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        uploadArea.classList.add('dragover');
    }
    
    function unhighlight() {
        uploadArea.classList.remove('dragover');
    }
    
    uploadArea.addEventListener('drop', handleDrop, false);
    uploadArea.addEventListener('click', () => {
        console.log('ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ');
        document.getElementById('bgFileInput').click();
    });
    
    function handleDrop(e) {
        console.log('æ‹–æ‹½æ”¾ä¸‹äº‹ä»¶');
        const dt = e.dataTransfer;
        const files = dt.files;
        console.log('æ‹–æ‹½çš„æ–‡ä»¶æ•°é‡:', files.length);
        
        if (files.length > 0) {
            console.log('å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶:', files[0].name, files[0].type);
            handleFileUpload(files[0]);
        }
    }
}

function bindBackgroundEvents() {
    const bgBtn = $('#bgBtn');
    console.log('ç»‘å®šèƒŒæ™¯äº‹ä»¶ï¼ŒæŒ‰é’®å…ƒç´ :', bgBtn);
    if (bgBtn) {
        bgBtn.addEventListener('click', openBackgroundDialog);
        console.log('èƒŒæ™¯æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.error('æ‰¾ä¸åˆ°èƒŒæ™¯æŒ‰é’® #bgBtn');
    }
    
    // ç»‘å®šå¯¹è¯æ¡†å†…çš„äº‹ä»¶
    const fileInput = document.getElementById('bgFileInput');
    if (fileInput) {
        console.log('ç»‘å®šæ–‡ä»¶è¾“å…¥æ¡†äº‹ä»¶');
        fileInput.addEventListener('change', (e) => {
            console.log('æ–‡ä»¶è¾“å…¥æ¡†changeäº‹ä»¶', e.target.files.length);
            const file = e.target.files[0];
            if (file) {
                console.log('é€‰æ‹©çš„æ–‡ä»¶:', file.name, file.type, file.size);
                handleFileUpload(file);
            }
        });
    } else {
        console.error('æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥æ¡† #bgFileInput');
    }
    
    const resetBtn = document.getElementById('resetBgBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', resetBackground);
    }
    
    const cancelBtn = document.getElementById('cancelBgBtn');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', closeBackgroundDialog);
    }
    
    const applyUrlBtn = document.getElementById('applyUrlBtn');
    if (applyUrlBtn) {
        applyUrlBtn.addEventListener('click', handleUrlBackground);
    }
    
    // ä¸ºURLè¾“å…¥æ¡†æ·»åŠ å›è½¦é”®äº‹ä»¶
    const urlInput = document.getElementById('bgUrlInput');
    if (urlInput) {
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUrlBackground();
            }
        });
    }
    
    setupDragAndDrop();
}

// è®¾ç½®é¢æ¿æ§åˆ¶
function initSettingsPanel() {
  const settingsFab = $('#settingsFab');
  const settingsPanel = $('#settingsPanel');
  
  if (!settingsFab || !settingsPanel) return;
  
  // åˆ‡æ¢è®¾ç½®é¢æ¿æ˜¾ç¤º/éšè—
  settingsFab.addEventListener('click', (e) => {
    e.stopPropagation();
    settingsPanel.classList.toggle('show');
  });
  
  // é˜»æ­¢é¢æ¿å†…ç‚¹å‡»å†’æ³¡åˆ°document
  settingsPanel.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­è®¾ç½®é¢æ¿
  document.addEventListener('click', (e) => {
    if (!settingsPanel.contains(e.target) && !settingsFab.contains(e.target)) {
      settingsPanel.classList.remove('show');
    }
  });
  
  // ç»‘å®šé¢æ¿ä¸­çš„æŒ‰é’®äº‹ä»¶
  const panelSoundBtn = $('#panelSoundBtn');
  const panelFocusBtn = $('#panelFocusBtn');
  const panelBgBtn = $('#panelBgBtn');
  const panelBookmarksBtn = $('#panelBookmarksBtn');
  const panelAppearanceBtn = $('#panelAppearanceBtn');
  
  if (panelSoundBtn) {
    panelSoundBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
      settingsPanel.classList.remove('show');
      const soundPanel = $('#soundPanel');
      if (soundPanel) {
        soundPanel.classList.remove('hidden');
      }
    });
  }
  
  if (panelFocusBtn) {
    panelFocusBtn.addEventListener('click', () => {
      settingsPanel.classList.remove('show');
      openFocusMode();
    });
  }
  
  if (panelBgBtn) {
    panelBgBtn.addEventListener('click', () => {
      settingsPanel.classList.remove('show');
      openBackgroundDialog();
    });
  }

  if (panelBookmarksBtn) {
    panelBookmarksBtn.addEventListener('click', () => {
      settingsPanel.classList.remove('show');
      toggleBookmarksPanel();
    });
  }

  if (panelAppearanceBtn) {
    panelAppearanceBtn.addEventListener('click', () => {
      settingsPanel.classList.remove('show');
      document.getElementById('appearanceDialog').showModal();
    });
  }
}

// init - æé€Ÿå¯åŠ¨
async function init(){
  markCheckpoint('initå¯åŠ¨');
  
  // å¼‚æ­¥åˆå§‹åŒ–IndexedDBï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
  initIndexedDB().catch(() => console.warn('IndexedDBä¸å¯ç”¨'));
  
  // å…³é”®è·¯å¾„ï¼šç«‹å³åŠ è½½çŠ¶æ€
  loadState();
  markCheckpoint('çŠ¶æ€åŠ è½½');
  
  renderLinks();
  markCheckpoint('å¿«é€Ÿé“¾æ¥æ¸²æŸ“');
  
  updateClock();
  setInterval(updateClock, 1000*30);
  
  // å»¶è¿ŸåŠ è½½éå…³é”®å†…å®¹ï¼ˆå¤©æ°”ã€å¼•è¨€ï¼‰
  setTimeout(() => {
    loadQuote();
    loadWeather();
    setInterval(loadWeather, 3600000);
    markCheckpoint('éå…³é”®å†…å®¹åŠ è½½');
  }, 300);

  // åˆå§‹åŒ–è®¾ç½®é¢æ¿
  initSettingsPanel();

  // events - ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–
  $('#searchForm').addEventListener('submit', onSearch);
  $('#editLinksBtn').addEventListener('click', openEditor);
  $('#addLinkBtn').addEventListener('click', addLinkRow);
  $('#saveLinksBtn').addEventListener('click', saveEditor);
  $('#cancelEditBtn').addEventListener('click', ()=>$('#editDialog').close());
  
  // ç¼–è¾‘å¯¹è¯æ¡†æ ‡ç­¾é¡µåˆ‡æ¢
  const editTabs = document.getElementById('editTabs');
  if (editTabs) {
    editTabs.addEventListener('click', (e) => {
      if (!e.target.classList.contains('tab-btn')) return;
      
      const tabName = e.target.getAttribute('data-tab');
      const title = document.getElementById('editDialogTitle');
      
      // æ‰¹é‡æ›´æ–°ï¼šé¿å…é‡æ’
      requestAnimationFrame(() => {
        editTabs.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.toggle('active', btn === e.target);
        });
        
        document.querySelectorAll('.edit-panel').forEach(panel => {
          panel.classList.remove('active');
        });
        
        if (tabName === 'bookmarks') {
          document.getElementById('bookmarksEditPanel').classList.add('active');
          title.textContent = 'ç¼–è¾‘æ”¶è—å¤¹';
          document.getElementById('addLinkBtn').textContent = 'æ·»åŠ æ”¶è—å¤¹';
        } else if (tabName === 'engines') {
          document.getElementById('enginesPanel').classList.add('active');
          title.textContent = 'ç¼–è¾‘æœç´¢å¼•æ“';
          document.getElementById('addLinkBtn').style.display = 'none';
          renderEnginesEditor();
        } else {
          document.getElementById('linksPanel').classList.add('active');
          title.textContent = 'ç¼–è¾‘å¿«é€Ÿé“¾æ¥';
          document.getElementById('addLinkBtn').textContent = 'æ·»åŠ å¿«é€Ÿé“¾æ¥';
          document.getElementById('addLinkBtn').style.display = '';
        }
      });
    });
  }
  
  // theme toggle
  $('#themeToggle').addEventListener('click', toggleTheme);
  
  // æœç´¢å»ºè®®äº‹ä»¶ - ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–
  const searchInput = $('#searchInput');
  const debouncedShowSuggestions = debounce(showSearchSuggestions, 120);
  const searchSuggestions = $('#searchSuggestions');
  let preventHideSuggestions = false;

  searchInput.addEventListener('focus', showSearchSuggestions);
  searchInput.addEventListener('input', debouncedShowSuggestions);
  searchInput.addEventListener('blur', () => {
    setTimeout(() => {
      const active = document.activeElement;
      if (preventHideSuggestions || (active && searchSuggestions.contains(active))) return;
      hideSearchSuggestions();
    }, 120);
  });

  // åœ¨å»ºè®®åŒºåŸŸæŒ‰ä¸‹æ—¶è®¾ç½®æ ‡è®°
  searchSuggestions.addEventListener('pointerdown', () => { preventHideSuggestions = true; });
  searchSuggestions.addEventListener('pointerup', () => {
    setTimeout(() => { preventHideSuggestions = false; }, 180);
  });
  
  // é”®ç›˜å¯¼èˆªæ”¯æŒ
  let selectedSuggestionIndex = -1;
  searchInput.addEventListener('keydown', (e) => {
    const suggestions = document.querySelectorAll('.search-suggestion-item');
    if (suggestions.length === 0) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
      updateSuggestionSelection(suggestions);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
      updateSuggestionSelection(suggestions);
    } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
      e.preventDefault();
      suggestions[selectedSuggestionIndex].click();
    } else if (e.key === 'Escape') {
      hideSearchSuggestions();
      selectedSuggestionIndex = -1;
    }
  });

  function updateSuggestionSelection(suggestions) {
    suggestions.forEach((item, index) => {
      item.classList.toggle('selected', index === selectedSuggestionIndex);
    });
  }
  
  // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—å»ºè®®
  document.addEventListener('click', (e) => {
    const searchContainer = document.querySelector('.search-container');
    if (!searchContainer.contains(e.target)) {
      hideSearchSuggestions();
      selectedSuggestionIndex = -1;
    }
  });

  // background
  loadSavedBackground();
  bindBackgroundEvents();
  // bookmarks bindings (defensive: check elements exist before binding)
  const bookmarksBtn = document.getElementById('bookmarksBtn');
  const panelBookmarksBtn = document.getElementById('panelBookmarksBtn');
  const bookmarksOverlay = document.getElementById('bookmarksOverlay');
  const bookmarksCloseBtn = document.getElementById('closeBookmarksBtn');
  const bookmarkSearchInput = document.getElementById('bookmarksSearch');
  const addBookmarkBtn = document.getElementById('addBookmarkBtn');
  const importBookmarksBtn = document.getElementById('importBookmarksBtn');
  const exportBookmarksBtn = document.getElementById('exportBookmarksBtn');
  const desktopToggle = document.getElementById('desktopBookmarksToggle');

  if (bookmarksBtn) bookmarksBtn.addEventListener('click', openBookmarksPanel);
  if (panelBookmarksBtn) panelBookmarksBtn.addEventListener('click', openBookmarksPanel);
  if (bookmarksOverlay) bookmarksOverlay.addEventListener('click', closeBookmarksPanel);
  if (bookmarksCloseBtn) bookmarksCloseBtn.addEventListener('click', closeBookmarksPanel);
  
  // ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æœç´¢è¾“å…¥ï¼Œé¿å…é¢‘ç¹è§¦å‘æ¸²æŸ“
  if (bookmarkSearchInput) {
    bookmarkSearchInput.addEventListener('input', debounce((e) => { 
      renderBookmarks(e.target.value); 
    }, 200));
  }
  if (addBookmarkBtn) addBookmarkBtn.addEventListener('click', promptAddBookmark);
  if (importBookmarksBtn) importBookmarksBtn.addEventListener('click', handleBookmarkImport);
  if (exportBookmarksBtn) exportBookmarksBtn.addEventListener('click', exportBookmarks);
  if (desktopToggle) {
    desktopToggle.checked = bookmarksEnabled;
    desktopToggle.addEventListener('change', (e) => {
      bookmarksEnabled = !!e.target.checked;
      localStorage.setItem('startpage.bookmarksEnabled', bookmarksEnabled);
      renderDesktopBookmarks();
      showToast(bookmarksEnabled ? 'å·²å¯ç”¨æ¡Œé¢ä¹¦ç­¾' : 'å·²å…³é—­æ¡Œé¢ä¹¦ç­¾');
    });
  }

  // åˆå§‹æ¸²æŸ“æ¡Œé¢ä¹¦ç­¾
  renderDesktopBookmarks();

  // å¤©æ°”å¡ç‰‡äº‹ä»¶ç»‘å®š
  const weatherElement = document.getElementById('weather');
  const closeWeatherCardBtn = document.getElementById('closeWeatherCard');
  const weatherOverlay = document.getElementById('weatherOverlay');
  
  if (weatherElement) weatherElement.addEventListener('click', showWeatherCard);
  if (closeWeatherCardBtn) closeWeatherCardBtn.addEventListener('click', closeWeatherCard);
  if (weatherOverlay) weatherOverlay.addEventListener('click', closeWeatherCard);

  loadTheme();
  loadSync();
  bindSync();
}

window.addEventListener('DOMContentLoaded', init);

// é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæ€§èƒ½æŠ¥å‘Š
window.addEventListener('load', () => {
    const totalLoadTime = performance.now() - perfMetrics.startTime;
    console.log('\nğŸ¯ ==================== é¡µé¢åŠ è½½æ€§èƒ½æŠ¥å‘Š ====================');
    console.log(`âš¡ æ€»åŠ è½½æ—¶é—´: ${totalLoadTime.toFixed(1)}ms`);
    
    if (perfMetrics.checkpoints) {
        Object.entries(perfMetrics.checkpoints).forEach(([name, time]) => {
            console.log(`   âœ“ ${name}: ${time.toFixed(1)}ms`);
        });
    }
    
    // æ€§èƒ½è¯„çº§
    let rating = '';
    if (totalLoadTime < 100) {
        rating = 'ğŸ† æé€Ÿï¼å ªæ¯”Wallpaper Engine';
    } else if (totalLoadTime < 500) {
        rating = 'âœ… ä¼˜ç§€';
    } else if (totalLoadTime < 1000) {
        rating = 'âš ï¸ è‰¯å¥½';
    } else {
        rating = 'âŒ éœ€è¦ä¼˜åŒ–';
    }
    
    console.log(`   ${rating}`);
    console.log('=========================================================\n');
    
    // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºï¼ˆä»…å¼€å‘æ¨¡å¼ï¼Œ3ç§’åæ¶ˆå¤±ï¼‰
    if (totalLoadTime < 100) {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = `âš¡ åŠ è½½å®Œæˆ: ${totalLoadTime.toFixed(0)}ms`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    }
});

// Toast helper
function showToast(text, duration = 2500){
  const t = $('#toast');
  if(!t) return;
  t.textContent = text;
  t.classList.add('show');
  clearTimeout(t._timeout);
  t._timeout = setTimeout(()=>{ t.classList.remove('show'); }, duration);
}

// ==================== éŸ³æ•ˆæ’­æ”¾å™¨åŠŸèƒ½ ====================
const ambientSounds = [
  { 
    id: 'rain', 
    name: 'é›¨å£°', 
    url: 'music/rain.mp3',
    svg: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41M8 16l-1 2M12 14l-1 2M16 16l-1 2M8 10l-1 2M12 8l-1 2M16 10l-1 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
  },
  { 
    id: 'ocean', 
    name: 'æµ·æµª', 
    url: 'music/waves.mp3',
    svg: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 12c.5-2 2-3.5 4-3.5s3.5 1.5 4 3.5c.5-2 2-3.5 4-3.5s3.5 1.5 4 3.5c.5-2 2-3.5 4-3.5M2 16c.5-2 2-3.5 4-3.5s3.5 1.5 4 3.5c.5-2 2-3.5 4-3.5s3.5 1.5 4 3.5c.5-2 2-3.5 4-3.5M2 20c.5-2 2-3.5 4-3.5s3.5 1.5 4 3.5c.5-2 2-3.5 4-3.5s3.5 1.5 4 3.5c.5-2 2-3.5 4-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
  },
  { 
    id: 'forest', 
    name: 'æ£®æ—', 
    url: 'music/forest.mp3',
    svg: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L8 8h8l-4-6zM12 8L8 14h8l-4-6zM12 14L6 22h12l-6-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 22v-4h4v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
  },
  { 
    id: 'cafe', 
    name: 'å’–å•¡å…', 
    url: 'music/cafe.mp3',
    svg: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 1v3M10 1v3M14 1v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>'
  },
  { 
    id: 'fireplace', 
    name: 'å£ç‚‰', 
    url: 'music/fire.mp3',
    svg: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
  },
  { 
    id: 'thunder', 
    name: 'é›·é›¨', 
    url: 'music/rain and thunder.mp3',
    svg: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 16l-1 2M12 14l-1 2M16 16l-1 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>'
  }
];

let currentAudio = null;
let currentSoundId = null;

// åˆå§‹åŒ–éŸ³æ•ˆé¢æ¿
function initSoundPanel() {
  const soundList = $('#soundList');
  const soundBtn = $('#soundBtn');
  const soundPanel = $('#soundPanel');
  const closeSoundBtn = $('#closeSoundBtn');
  const volumeSlider = $('#volumeSlider');
  const volumeValue = $('#volumeValue');
  
  if (!soundList || !soundBtn) return;
  
  // æ¸²æŸ“éŸ³æ•ˆåˆ—è¡¨
  soundList.innerHTML = ambientSounds.map(sound => `
    <div class="sound-item" data-sound-id="${sound.id}">
      <div class="sound-info">
        <span class="sound-icon">${sound.svg}</span>
        <span class="sound-name">${sound.name}</span>
      </div>
      <div class="sound-status"></div>
    </div>
  `).join('');
  
  // Tabs åˆ‡æ¢é€»è¾‘
  const tabs = soundPanel.querySelectorAll('.tab-btn');
  const panels = soundPanel.querySelectorAll('.sound-content');
  
  if (tabs.length > 0) {
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // åˆ‡æ¢ Tab æ ·å¼
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // åˆ‡æ¢é¢æ¿æ˜¾ç¤º
        const targetId = tab.dataset.tab === 'music' ? 'musicPanel' : 'ambientPanel';
        panels.forEach(p => {
          if (p.id === targetId) {
              p.classList.remove('hidden');
              p.classList.add('active');
          } else {
              p.classList.add('hidden');
              p.classList.remove('active');
          }
        });
      });
    });
  }

  // ç½‘æ˜“äº‘éŸ³ä¹é€»è¾‘
  const musicIdInput = document.getElementById('musicIdInput');
  const loadMusicBtn = document.getElementById('loadMusicBtn');
  const musicHelpBtn = document.getElementById('musicHelpBtn');
  const musicSettingsBtn = document.getElementById('musicSettingsBtn');
  const saveMusicSettingsBtn = document.getElementById('saveMusicSettingsBtn');
  
  if (musicIdInput && loadMusicBtn) {
      // åŠ è½½ä¿å­˜çš„ ID
      const savedId = localStorage.getItem('startpage.musicId');
      if (savedId) {
          musicIdInput.value = savedId;
          // å»¶è¿ŸåŠ è½½ iframe ä»¥é¿å…é˜»å¡é¡µé¢åˆå§‹åŒ–
          setTimeout(() => loadNeteaseMusic(savedId), 1000);
      }
      
      loadMusicBtn.addEventListener('click', () => {
          let inputVal = musicIdInput.value.trim();
          
          // æ™ºèƒ½æå–ï¼šå¦‚æœè¾“å…¥çš„æ˜¯ URLï¼Œå°è¯•æå– ID
          if (inputVal.includes('music.163.com')) {
              const match = inputVal.match(/id=(\d+)/);
              if (match && match[1]) {
                  inputVal = match[1];
                  musicIdInput.value = inputVal; // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º ID
                  showToast('å·²è‡ªåŠ¨æå–æ­Œå•ID');
              }
          }
          
          if (inputVal && /^\d+$/.test(inputVal)) {
              loadNeteaseMusic(inputVal);
          } else {
              showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­Œå•IDæˆ–é“¾æ¥');
          }
      });

      // å¸®åŠ©æŒ‰é’®äº‹ä»¶
      if (musicHelpBtn) {
          musicHelpBtn.addEventListener('click', () => {
              alert('å¦‚ä½•è·å–æ­Œå•IDï¼š\n\n1. æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹å®˜ç½‘æˆ–å®¢æˆ·ç«¯\n2. è¿›å…¥ä½ å–œæ¬¢çš„æ­Œå•\n3. å¤åˆ¶é“¾æ¥ (ä¾‹å¦‚: .../playlist?id=123456)\n4. ç›´æ¥ç²˜è´´é“¾æ¥åˆ°è¾“å…¥æ¡†ï¼Œç‚¹å‡»åŠ è½½å³å¯\n\næç¤ºï¼šä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥ id æ•°å­—');
          });
      }
      
      // éŸ³ä¹è®¾ç½®æŒ‰é’®
      if (musicSettingsBtn) {
          musicSettingsBtn.addEventListener('click', () => {
              const dialog = document.getElementById('musicSettingsDialog');
              const apiInput = document.getElementById('customMusicApiInput');
              const cookieInput = document.getElementById('musicCookieInput');
              
              // åŠ è½½ä¿å­˜çš„è®¾ç½®
              apiInput.value = localStorage.getItem('startpage.musicApi') || '';
              cookieInput.value = localStorage.getItem('startpage.musicCookie') || '';
              
              dialog.showModal();
          });
      }
      
      // ä¿å­˜éŸ³ä¹è®¾ç½®
      if (saveMusicSettingsBtn) {
          saveMusicSettingsBtn.addEventListener('click', () => {
              const apiInput = document.getElementById('customMusicApiInput');
              const cookieInput = document.getElementById('musicCookieInput');
              
              const api = apiInput.value.trim();
              const cookie = cookieInput.value.trim();
              
              if (api) {
                  localStorage.setItem('startpage.musicApi', api);
              } else {
                  localStorage.removeItem('startpage.musicApi');
              }
              
              if (cookie) {
                  localStorage.setItem('startpage.musicCookie', cookie);
              } else {
                  localStorage.removeItem('startpage.musicCookie');
              }
              
              showToast('éŸ³ä¹è®¾ç½®å·²ä¿å­˜');
              document.getElementById('musicSettingsDialog').close();
              
              // å¦‚æœæœ‰æ­£åœ¨æ’­æ”¾çš„æ­Œå•ï¼Œæç¤ºé‡æ–°åŠ è½½
              if (musicIdInput.value) {
                  if (confirm('è®¾ç½®å·²æ›´æ–°ï¼Œæ˜¯å¦é‡æ–°åŠ è½½æ­Œå•ï¼Ÿ')) {
                      loadNeteaseMusic(musicIdInput.value);
                  }
              }
          });
      }
  }
  
  // ç»‘å®šäº‹ä»¶
  soundBtn.addEventListener('click', () => {
    soundPanel.classList.toggle('hidden');
  });
  
  if (closeSoundBtn) {
    closeSoundBtn.addEventListener('click', () => {
      soundPanel.classList.add('hidden');
    });
  }
  
  // éŸ³æ•ˆé€‰æ‹©
  soundList.querySelectorAll('.sound-item').forEach(item => {
    item.addEventListener('click', () => {
      const soundId = item.dataset.soundId;
      toggleSound(soundId);
    });
  });
  
  // éŸ³é‡æ§åˆ¶
  if (volumeSlider) {
    volumeSlider.addEventListener('input', (e) => {
      const volume = e.target.value;
      volumeValue.textContent = `${volume}%`;
      if (currentAudio) {
        currentAudio.volume = volume / 100;
      }
      localStorage.setItem('startpage.soundVolume', volume);
    });
    
    // åŠ è½½ä¿å­˜çš„éŸ³é‡
    const savedVolume = localStorage.getItem('startpage.soundVolume') || '50';
    volumeSlider.value = savedVolume;
    volumeValue.textContent = `${savedVolume}%`;
  }
  
  // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
  document.addEventListener('click', (e) => {
    const panelSoundBtn = $('#panelSoundBtn');
    const isClickInsidePanel = soundPanel && soundPanel.contains(e.target);
    const isClickOnSoundBtn = soundBtn && soundBtn.contains(e.target);
    const isClickOnPanelBtn = panelSoundBtn && panelSoundBtn.contains(e.target);
    
    if (!isClickInsidePanel && !isClickOnSoundBtn && !isClickOnPanelBtn) {
      soundPanel.classList.add('hidden');
    }
  });

  // Floating Player Events
  const fpPrev = document.getElementById('fpPrevBtn');
  const fpPlay = document.getElementById('fpPlayBtn');
  const fpNext = document.getElementById('fpNextBtn');
  const fpList = document.getElementById('fpListBtn');
  
  if (fpPrev) fpPrev.addEventListener('click', previousMusic);
  if (fpPlay) fpPlay.addEventListener('click', toggleMusicPlay);
  if (fpNext) fpNext.addEventListener('click', nextMusic);
  if (fpList) fpList.addEventListener('click', (e) => {
      e.stopPropagation();
      soundPanel.classList.remove('hidden');
      const musicTab = document.querySelector('[data-tab="music"]');
      if (musicTab) musicTab.click();
  });
}

// éŸ³ä¹æ’­æ”¾å™¨çŠ¶æ€
let musicState = {
    playlist: [],
    currentIndex: 0,
    isPlaying: false,
    playMode: 'sequence', // sequence, single, random
    audio: null,
    duration: 0,
    currentTime: 0
};

// ä»ç½‘æ˜“äº‘ API è·å–æ­Œå•ä¿¡æ¯
async function fetchNeteaseMusicList(id) {
    try {
        console.log('å°è¯•åŠ è½½æ­Œå•ID:', id);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰ API å’Œ Cookie
        const customApi = localStorage.getItem('startpage.musicApi');
        const customCookie = localStorage.getItem('startpage.musicCookie');
        
        if (customApi) {
            console.log('ä½¿ç”¨è‡ªå®šä¹‰ API:', customApi);
            // ä½¿ç”¨è‡ªå®šä¹‰ NeteaseCloudMusicApi
            // æ ¼å¼é€šå¸¸æ˜¯ /playlist/detail?id=xxx è·å–æ­Œå•è¯¦æƒ…ï¼Œç„¶å /song/url?id=xxx è·å–é“¾æ¥
            // ä½†ä¸ºäº†å…¼å®¹ Meting æ ¼å¼ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·å¯èƒ½ä½¿ç”¨çš„æ˜¯å…¼å®¹ Meting çš„ APIï¼Œæˆ–è€…æˆ‘ä»¬éœ€è¦è‡ªå·±é€‚é…
            
            // å¦‚æœç”¨æˆ·å¡«çš„æ˜¯æ ‡å‡† NeteaseCloudMusicApi (Binaryifyç‰ˆ)
            // æˆ‘ä»¬éœ€è¦å…ˆè·å–æ­Œå•è¯¦æƒ…ï¼Œå†è·å–æ­Œæ›²è¯¦æƒ…
            
            // 1. è·å–æ­Œå•è¯¦æƒ…
            let playlistUrl = `${customApi}/playlist/track/all?id=${id}&limit=1000&offset=0`;
            if (customCookie) {
                // åªæœ‰åœ¨ HTTPS ä¸‹æ‰èƒ½å®‰å…¨å‘é€ Cookieï¼Œæˆ–è€…ç”¨æˆ·è‡ªå»º API å…è®¸è·¨åŸŸæºå¸¦å‡­è¯
                // è¿™é‡Œæˆ‘ä»¬å°è¯•é€šè¿‡ query å‚æ•°ä¼ é€’ cookie (éƒ¨åˆ†éƒ¨ç½²æ”¯æŒ) æˆ–è€… xhr withCredentials
                // æ ‡å‡† NeteaseCloudMusicApi æ”¯æŒ ?cookie=xxx
                playlistUrl += `&cookie=${encodeURIComponent(customCookie)}`;
            }
            
            const response = await fetch(playlistUrl);
            if (!response.ok) throw new Error(`è‡ªå®šä¹‰ API HTTP ${response.status}`);
            
            const data = await response.json();
            
            if (data.songs && Array.isArray(data.songs)) {
                // 2. è·å–æ­Œæ›² URL (éœ€è¦æ‰¹é‡è·å–)
                const trackIds = data.songs.map(s => s.id).join(',');
                let songUrlApi = `${customApi}/song/url?id=${trackIds}`;
                if (customCookie) songUrlApi += `&cookie=${encodeURIComponent(customCookie)}`;
                
                const urlResponse = await fetch(songUrlApi);
                const urlData = await urlResponse.json();
                const urlMap = {};
                if (urlData.data) {
                    urlData.data.forEach(u => urlMap[u.id] = u.url);
                }
                
                return data.songs.map(track => ({
                    id: track.id,
                    name: track.name,
                    artist: track.ar ? track.ar.map(a => a.name).join('/') : 'æœªçŸ¥æ­Œæ‰‹',
                    album: track.al ? track.al.name : 'æœªçŸ¥ä¸“è¾‘',
                    duration: track.dt,
                    url: urlMap[track.id], // å¯èƒ½ä¸ºç©º(VIP)
                    cover: track.al ? track.al.picUrl : null,
                    lrc: null // æ­Œè¯æš‚ä¸è·å–
                })).filter(t => t.url); // è¿‡æ»¤æ‰æ²¡æœ‰ URL çš„æ­Œæ›²
            }
        }
        
        // é»˜è®¤æ–¹æ¡ˆ: ä½¿ç”¨ Meting API (æ”¯æŒ CORSï¼Œç¨³å®šæ€§å¥½)
        // è¿™æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„å…¬å…± APIï¼Œä¸“é—¨ç”¨äºè§£æç½‘æ˜“äº‘éŸ³ä¹é“¾æ¥
        const apiUrl = `https://api.i-meto.com/meting/api?server=netease&type=playlist&id=${id}`;
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        console.log('API è¿”å›æ•°æ®:', data);
        
        if (Array.isArray(data) && data.length > 0) {
            // Meting API è¿”å›æ ¼å¼è½¬æ¢
            return data.map((track, index) => ({
                id: index,
                name: track.title || 'æœªçŸ¥æ­Œæ›²',
                artist: track.author || 'æœªçŸ¥æ­Œæ‰‹',
                album: 'åœ¨çº¿éŸ³ä¹',
                duration: 0, // API å¯èƒ½ä¸è¿”å›æ—¶é•¿
                url: track.url,
                cover: track.pic, // å°é¢å›¾
                lrc: track.lrc
            }));
        } else {
            console.warn('APIè¿”å›ç©ºæ•°æ®');
            return await fetchNeteaseMusicListBackup(id);
        }
    } catch (error) {
        console.error('ä¸» API è·å–å¤±è´¥:', error);
        // å°è¯•å¤‡ç”¨æ–¹æ¡ˆ
        return await fetchNeteaseMusicListBackup(id);
    }
}

// å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å¦ä¸€ä¸ª Meting API æœåŠ¡
async function fetchNeteaseMusicListBackup(id) {
    try {
        console.log('å°è¯•å¤‡ç”¨ API:', id);
        
        // æ–¹æ¡ˆ2: ä½¿ç”¨ injahow çš„ Meting API
        const apiUrl = `https://api.injahow.cn/meting/?type=playlist&id=${id}`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) throw new Error(`å¤‡ç”¨ API HTTP ${response.status}`);
        
        const data = await response.json();
        console.log('å¤‡ç”¨ API è¿”å›æ•°æ®:', data);
        
        if (Array.isArray(data) && data.length > 0) {
            return data.map((track, index) => ({
                id: index,
                name: track.name || track.title || 'æœªçŸ¥æ­Œæ›²',
                artist: track.artist || track.author || 'æœªçŸ¥æ­Œæ‰‹',
                album: 'åœ¨çº¿éŸ³ä¹',
                duration: 0,
                url: track.url,
                cover: track.pic || track.cover,
                lrc: track.lrc
            }));
        } else {
            showToast('æ­Œå•ä¸ºç©ºæˆ–å—ç‰ˆæƒä¿æŠ¤');
            return [];
        }
    } catch (error) {
        console.error('å¤‡ç”¨ API ä¹Ÿå¤±è´¥äº†:', error);
        showToast('è·å–æ­Œå•å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ° API æœåŠ¡');
        return [];
    }
}

// åŠ è½½ç½‘æ˜“äº‘æ­Œå•å¹¶åˆå§‹åŒ–æ’­æ”¾å™¨
async function loadNeteaseMusic(id) {
    const container = document.getElementById('musicPlayerContainer');
    if (!container) return;
    
    if (!id) {
        container.innerHTML = '<div class="music-placeholder"><p>è¯·è¾“å…¥æ­Œå•IDå¹¶åŠ è½½</p><small>æç¤º: ç½‘é¡µç‰ˆæ­Œå•URLä¸­çš„ id å‚æ•°<br>ä¾‹å¦‚: https://music.163.com/#/playlist?id=7452421</small></div>';
        return;
    }
    
    // ç‰¹æ®Šæ¨¡å¼ï¼šè¾“å…¥ "test" ä½¿ç”¨æµ‹è¯•æ•°æ®
    if (id === 'test') {
        const testPlaylist = [
            { id: 1, name: 'æµ‹è¯•æ­Œæ›² 1', artist: 'æµ‹è¯•è‰ºæœ¯å®¶', album: 'æµ‹è¯•ä¸“è¾‘', duration: 180000, url: 'https://music.163.com/song/media/outer/url?id=1' },
            { id: 2, name: 'æµ‹è¯•æ­Œæ›² 2', artist: 'æµ‹è¯•è‰ºæœ¯å®¶', album: 'æµ‹è¯•ä¸“è¾‘', duration: 200000, url: 'https://music.163.com/song/media/outer/url?id=2' },
            { id: 3, name: 'æµ‹è¯•æ­Œæ›² 3', artist: 'æµ‹è¯•è‰ºæœ¯å®¶', album: 'æµ‹è¯•ä¸“è¾‘', duration: 220000, url: 'https://music.163.com/song/media/outer/url?id=3' }
        ];
        musicState.playlist = testPlaylist;
        musicState.currentIndex = 0;
        musicState.isPlaying = false;
        renderMusicPlayer(container);
        showToast('âœ… å·²åŠ è½½æµ‹è¯•æ­Œå•ï¼ˆ3é¦–æ­Œæ›²ï¼‰');
        // Show floating player
        const fp = document.getElementById('floatingPlayer');
        if (fp) fp.classList.remove('hidden');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.innerHTML = '<div class="music-placeholder"><p>â³ æ­£åœ¨åŠ è½½æ­Œå•...</p><small>è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</small></div>';
    
    try {
        // è·å–æ­Œå•æ•°æ®
        const playlist = await fetchNeteaseMusicList(id);
        
        if (playlist.length === 0) {
            container.innerHTML = `
                <div class="music-placeholder">
                    <p>âŒ åŠ è½½æ­Œå•å¤±è´¥</p>
                    <small>
                        å¯èƒ½åŸå› ï¼š<br>
                        1. æ­Œå•IDä¸æ­£ç¡®<br>
                        2. æ­Œå•å—ç‰ˆæƒä¿æŠ¤<br>
                        3. ç½‘ç»œè¿æ¥é—®é¢˜<br><br>
                        ğŸ’¡ æç¤ºï¼šè¾“å…¥ "test" å¯ä»¥åŠ è½½æµ‹è¯•æ•°æ®
                    </small>
                </div>
            `;
            return;
        }
        
        // åˆå§‹åŒ–æ’­æ”¾å™¨
        musicState.playlist = playlist;
        musicState.currentIndex = 0;
        musicState.isPlaying = false;
        
        // æ¸²æŸ“æ’­æ”¾å™¨ UI
        renderMusicPlayer(container);
        
        localStorage.setItem('startpage.musicId', id);
        showToast(` å·²åŠ è½½ ${playlist.length} é¦–æ­Œæ›²`);

        // Show floating player
        const fp = document.getElementById('floatingPlayer');
        if (fp) fp.classList.remove('hidden');
    } catch (error) {
        console.error('åŠ è½½æ­Œå•å‡ºé”™:', error);
        container.innerHTML = `
            <div class="music-placeholder">
                <p> åŠ è½½å¤±è´¥</p>
                <small>${error.message}<br><br>è¯·ç¨åé‡è¯•</small>
            </div>
        `;
    }
}

// æ¸²æŸ“éŸ³ä¹æ’­æ”¾å™¨ UI
function renderMusicPlayer(container) {
    container.innerHTML = `
        <div class="music-player-ui">
            <!-- å½“å‰æ’­æ”¾æ­Œæ›²ä¿¡æ¯ -->
            <div class="music-now-playing">
                <div class="music-cover" style="background:linear-gradient(135deg,#667eea,#764ba2);"></div>
                <div class="music-track-info">
                    <div class="music-track-name" id="musicTrackName">æœªé€‰æ‹©æ­Œæ›²</div>
                    <div class="music-track-artist" id="musicTrackArtist">-</div>
                </div>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="music-progress">
                <input type="range" id="musicProgressBar" min="0" max="100" value="0">
                <div class="music-time-labels">
                    <span id="musicCurrentTime">0:00</span>
                    <span id="musicDuration">0:00</span>
                </div>
            </div>
            
            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="music-controls">
                <button id="musicModeBtn" class="music-btn" title="é¡ºåºæ’­æ”¾">
                    <!-- é¡ºåºæ’­æ”¾å›¾æ ‡ -->
                    <svg id="iconSequence" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 1l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 11V9a4 4 0 014-4h14M7 23l-4-4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 13v2a4 4 0 01-4 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <!-- å•æ›²å¾ªç¯å›¾æ ‡ -->
                    <svg id="iconSingle" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none;">
                        <path d="M17 1l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 11V9a4 4 0 014-4h14M7 23l-4-4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 13v2a4 4 0 01-4 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <text x="10" y="17" font-size="8" fill="currentColor" font-weight="bold">1</text>
                    </svg>
                    <!-- éšæœºæ’­æ”¾å›¾æ ‡ -->
                    <svg id="iconRandom" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none;">
                        <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l5 5M4 4l5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button id="musicPrevBtn" class="music-btn" title="ä¸Šä¸€é¦–">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 20L9 12l10-8v16zM5 19V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button id="musicPlayBtn" class="music-btn music-play-btn" title="æ’­æ”¾/æš‚åœ">
                    <svg id="musicPlayIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="musicPauseIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="display:none;">
                        <rect x="6" y="4" width="4" height="16" rx="1"/>
                        <rect x="14" y="4" width="4" height="16" rx="1"/>
                    </svg>
                </button>
                <button id="musicNextBtn" class="music-btn" title="ä¸‹ä¸€é¦–">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 4l10 8-10 8V4zM19 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <!-- æ­Œæ›²åˆ—è¡¨ -->
            <div class="music-playlist" id="musicPlaylist">
                <!-- æ­Œæ›²å°†åŠ¨æ€æ’å…¥ -->
            </div>
        </div>
    `;
    
    // æ›´æ–°æ­Œæ›²ä¿¡æ¯æ˜¾ç¤º
    updateMusicDisplay();
    
    // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨
    renderMusicPlaylist();
    
    // ç»‘å®šäº‹ä»¶
    bindMusicPlayerEvents();
}

// æ›´æ–°éŸ³ä¹æ’­æ”¾å™¨æ˜¾ç¤º
function updateMusicDisplay() {
    const track = musicState.playlist[musicState.currentIndex];
    if (!track) return;
    
    const nameEl = document.getElementById('musicTrackName');
    const artistEl = document.getElementById('musicTrackArtist');
    if(nameEl) nameEl.textContent = track.name;
    if(artistEl) artistEl.textContent = track.artist;
    
    // æ›´æ–°å°é¢
    const coverEl = document.querySelector('.music-cover');
    if (coverEl) {
        if (track.cover) {
            coverEl.style.background = `url(${track.cover}) center/cover no-repeat`;
        } else {
            coverEl.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
        }
    }

    // Update floating player
    const fpTitle = document.getElementById('fpTitle');
    const fpArtist = document.getElementById('fpArtist');
    const fpCover = document.querySelector('.fp-cover');
    
    if (fpTitle) fpTitle.textContent = track.name;
    if (fpArtist) fpArtist.textContent = track.artist;
    if (fpCover) {
        if (track.cover) {
            fpCover.style.background = `url(${track.cover}) center/cover no-repeat`;
        } else {
            fpCover.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
        }
    }
}

// æ¸²æŸ“æ­Œæ›²åˆ—è¡¨
function renderMusicPlaylist() {
    const container = document.getElementById('musicPlaylist');
    container.innerHTML = '';
    
    const fragment = document.createDocumentFragment();
    
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'music-list-item' + (index === musicState.currentIndex ? ' active' : '');
        
        // æ’­æ”¾åŠ¨ç”»HTML
        const playingIndicator = index === musicState.currentIndex && musicState.isPlaying ? 
            `<div class="playing-indicator">
                <div class="playing-bar"></div>
                <div class="playing-bar"></div>
                <div class="playing-bar"></div>
             </div>` : '';
        
        item.innerHTML = `
            <div class="music-list-item-info">
                <div class="music-list-item-title">${track.name}</div>
                <div class="music-list-item-artist">${track.artist}</div>
            </div>
            ${playingIndicator}
        `;
        
        item.addEventListener('click', () => {
            musicState.currentIndex = index;
            updateMusicDisplay();
            playMusic();
            updateMusicPlaylistUI();
        });
        
        fragment.appendChild(item);
    });
    
    container.appendChild(fragment);
}

// æ›´æ–°æ­Œæ›²åˆ—è¡¨ UI é€‰ä¸­çŠ¶æ€
function updateMusicPlaylistUI() {
    // é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ä»¥æ›´æ–°æ’­æ”¾åŠ¨ç”»çŠ¶æ€
    renderMusicPlaylist();
    
    // æ»šåŠ¨åˆ°å½“å‰æ’­æ”¾çš„æ­Œæ›²
    const activeItem = document.querySelector('.music-list-item.active');
    if (activeItem) {
        activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// ç»‘å®šéŸ³ä¹æ’­æ”¾å™¨äº‹ä»¶
function bindMusicPlayerEvents() {
    const playBtn = document.getElementById('musicPlayBtn');
    const prevBtn = document.getElementById('musicPrevBtn');
    const nextBtn = document.getElementById('musicNextBtn');
    const modeBtn = document.getElementById('musicModeBtn');
    const progressBar = document.getElementById('musicProgressBar');
    
    if (playBtn) playBtn.addEventListener('click', toggleMusicPlay);
    if (prevBtn) prevBtn.addEventListener('click', previousMusic);
    if (nextBtn) nextBtn.addEventListener('click', () => nextMusic(true)); // æ‰‹åŠ¨ç‚¹å‡»ä¸‹ä¸€é¦–
    if (modeBtn) modeBtn.addEventListener('click', togglePlayMode);
    if (progressBar) progressBar.addEventListener('input', seekMusic);
}

// åˆ‡æ¢æ’­æ”¾æ¨¡å¼
function togglePlayMode() {
    const modes = ['sequence', 'single', 'random'];
    const nextIndex = (modes.indexOf(musicState.playMode) + 1) % modes.length;
    musicState.playMode = modes[nextIndex];
    updatePlayModeUI();
    
    const modeNames = {
        'sequence': 'é¡ºåºæ’­æ”¾',
        'single': 'å•æ›²å¾ªç¯',
        'random': 'éšæœºæ’­æ”¾'
    };
    showToast(`å·²åˆ‡æ¢åˆ°${modeNames[musicState.playMode]}`);
}

// æ›´æ–°æ’­æ”¾æ¨¡å¼UI
function updatePlayModeUI() {
    const btn = document.getElementById('musicModeBtn');
    const iconSequence = document.getElementById('iconSequence');
    const iconSingle = document.getElementById('iconSingle');
    const iconRandom = document.getElementById('iconRandom');
    
    if (!btn) return;
    
    // éšè—æ‰€æœ‰å›¾æ ‡
    if(iconSequence) iconSequence.style.display = 'none';
    if(iconSingle) iconSingle.style.display = 'none';
    if(iconRandom) iconRandom.style.display = 'none';
    
    // æ˜¾ç¤ºå½“å‰æ¨¡å¼å›¾æ ‡
    switch (musicState.playMode) {
        case 'sequence':
            if(iconSequence) iconSequence.style.display = 'block';
            btn.title = 'é¡ºåºæ’­æ”¾';
            break;
        case 'single':
            if(iconSingle) iconSingle.style.display = 'block';
            btn.title = 'å•æ›²å¾ªç¯';
            break;
        case 'random':
            if(iconRandom) iconRandom.style.display = 'block';
            btn.title = 'éšæœºæ’­æ”¾';
            break;
    }
}

// æ’­æ”¾/æš‚åœéŸ³ä¹
function toggleMusicPlay() {
    if (musicState.isPlaying) {
        pauseMusic();
    } else {
        playMusic();
    }
}

// æ’­æ”¾éŸ³ä¹
function playMusic() {
    const track = musicState.playlist[musicState.currentIndex];
    if (!track) return;
    
    // å¦‚æœå·²æœ‰éŸ³é¢‘å¯¹è±¡
    if (musicState.audio) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€é¦–æ­Œï¼ˆé€šè¿‡æ¯”è¾ƒç´¢å¼•ï¼‰
        // å¦‚æœ audio å¯¹è±¡ä¸Šæœ‰ _index å±æ€§ä¸”ç­‰äºå½“å‰ç´¢å¼•ï¼Œè¯´æ˜æ˜¯åŒä¸€é¦–æ­Œ
        if (typeof musicState.audio._index === 'number' && musicState.audio._index === musicState.currentIndex) {
            if (musicState.audio.paused) {
                musicState.audio.play().catch(error => {
                    console.error('æ¢å¤æ’­æ”¾å¤±è´¥:', error);
                    // å¦‚æœæ¢å¤å¤±è´¥ï¼Œå°è¯•é‡æ–°åŠ è½½
                    musicState.audio.load();
                    musicState.audio.play().catch(e => console.error('é‡è¯•å¤±è´¥:', e));
                });
            }
            return;
        }
        
        // å¦‚æœä¸æ˜¯åŒä¸€é¦–æ­Œï¼Œåœæ­¢å½“å‰æ’­æ”¾å¹¶é”€æ¯
        musicState.audio.pause();
        musicState.audio = null;
    }
    
    // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡
    musicState.audio = new Audio(track.url);
    musicState.audio._index = musicState.currentIndex; // è®°å½•ç´¢å¼•ç”¨äºæ¯”å¯¹
    musicState.audio.crossOrigin = 'anonymous';
    
    // ç»‘å®šäº‹ä»¶
    musicState.audio.addEventListener('play', () => {
        musicState.isPlaying = true;
        updatePlayButtonIcon();
    });
    
    musicState.audio.addEventListener('pause', () => {
        musicState.isPlaying = false;
        updatePlayButtonIcon();
    });
    
    musicState.audio.addEventListener('timeupdate', updateMusicProgress);
    
    musicState.audio.addEventListener('loadedmetadata', () => {
        musicState.duration = musicState.audio.duration;
        document.getElementById('musicDuration').textContent = formatTime(musicState.duration);
    });
    
    musicState.audio.addEventListener('ended', () => nextMusic(false));
    
    musicState.audio.addEventListener('error', (e) => {
        console.warn('æ’­æ”¾å‡ºé”™:', e);
        showToast('æ­Œæ›²åŠ è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€é¦–');
        // å»¶è¿Ÿåˆ‡æ¢ï¼Œé¿å…å¿«é€Ÿè¿ç»­æŠ¥é”™å¯¼è‡´å¡æ­»
        setTimeout(() => {
            if (musicState.isPlaying) nextMusic();
        }, 1000);
    });
    
    // å¼€å§‹æ’­æ”¾
    const playPromise = musicState.audio.play();
    if (playPromise !== undefined) {
        playPromise.catch(error => {
            console.error('æ’­æ”¾å¤±è´¥:', error);
            musicState.isPlaying = false;
            updatePlayButtonIcon();
            
            if (error.name === 'NotAllowedError') {
                showToast('éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾');
            } else {
                showToast('æ— æ³•æ’­æ”¾æ­¤æ­Œæ›²');
            }
        });
    }
}

// æš‚åœéŸ³ä¹
function pauseMusic() {
    if (musicState.audio) {
        musicState.audio.pause();
        musicState.isPlaying = false;
        updatePlayButtonIcon();
    }
}

// ä¸Šä¸€é¦–
function previousMusic() {
    if (musicState.playlist.length === 0) return;
    
    if (musicState.playMode === 'random') {
        // éšæœºæ¨¡å¼ä¸‹ä¸Šä¸€é¦–ä¹Ÿéšæœº
        let newIndex = musicState.currentIndex;
        while (newIndex === musicState.currentIndex && musicState.playlist.length > 1) {
            newIndex = Math.floor(Math.random() * musicState.playlist.length);
        }
        musicState.currentIndex = newIndex;
    } else {
        // é¡ºåºæˆ–å•æ›²å¾ªç¯æ¨¡å¼ï¼ˆæ‰‹åŠ¨åˆ‡æ­Œæ—¶å•æ›²å¾ªç¯ä¹Ÿåˆ‡åˆ°ä¸Šä¸€é¦–ï¼‰
        musicState.currentIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length;
    }
    
    updateMusicDisplay();
    updateMusicPlaylistUI();
    playMusic();
}

// ä¸‹ä¸€é¦–
function nextMusic(isManual = false) {
    if (musicState.playlist.length === 0) return;
    
    if (musicState.playMode === 'single' && !isManual) {
        // å•æ›²å¾ªç¯ä¸”éæ‰‹åŠ¨åˆ‡æ¢ï¼Œä¿æŒå½“å‰ç´¢å¼•
        // é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
        musicState.audio.currentTime = 0;
        musicState.audio.play();
        return;
    }
    
    if (musicState.playMode === 'random') {
        // éšæœºæ¨¡å¼
        let newIndex = musicState.currentIndex;
        while (newIndex === musicState.currentIndex && musicState.playlist.length > 1) {
            newIndex = Math.floor(Math.random() * musicState.playlist.length);
        }
        musicState.currentIndex = newIndex;
    } else {
        // é¡ºåºæ¨¡å¼
        musicState.currentIndex = (musicState.currentIndex + 1) % musicState.playlist.length;
    }
    
    updateMusicDisplay();
    updateMusicPlaylistUI();
    playMusic();
}

// æ›´æ–°æ’­æ”¾æŒ‰é’®å›¾æ ‡
function updatePlayButtonIcon() {
    const playIcon = document.getElementById('musicPlayIcon');
    const pauseIcon = document.getElementById('musicPauseIcon');
    
    // Floating player icons
    const fpPlayIcon = document.getElementById('fpPlayIcon');
    const fpPauseIcon = document.getElementById('fpPauseIcon');
    
    if (musicState.isPlaying) {
        if(playIcon) playIcon.style.display = 'none';
        if(pauseIcon) pauseIcon.style.display = 'block';
        if(fpPlayIcon) fpPlayIcon.classList.add('hidden');
        if(fpPauseIcon) fpPauseIcon.classList.remove('hidden');
    } else {
        if(playIcon) playIcon.style.display = 'block';
        if(pauseIcon) pauseIcon.style.display = 'none';
        if(fpPlayIcon) fpPlayIcon.classList.remove('hidden');
        if(fpPauseIcon) fpPauseIcon.classList.add('hidden');
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateMusicProgress() {
    if (!musicState.audio) return;
    
    const current = musicState.audio.currentTime;
    const duration = musicState.audio.duration;
    
    if (!isNaN(duration)) {
        document.getElementById('musicProgressBar').value = (current / duration) * 100;
        document.getElementById('musicCurrentTime').textContent = formatTime(current);
    }
}

// æ‹–åŠ¨è¿›åº¦æ¡
function seekMusic(event) {
    if (!musicState.audio) return;
    
    const percent = event.target.value / 100;
    const newTime = percent * musicState.audio.duration;
    musicState.audio.currentTime = newTime;
}

// æ—¶é—´æ ¼å¼åŒ–
function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// åˆ‡æ¢éŸ³æ•ˆæ’­æ”¾
function toggleSound(soundId) {
  const sound = ambientSounds.find(s => s.id === soundId);
  if (!sound) return;
  
  // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ’­æ”¾çš„éŸ³æ•ˆï¼Œåœæ­¢æ’­æ”¾
  if (currentSoundId === soundId && currentAudio) {
    stopSound();
    return;
  }
  
  // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³æ•ˆ
  if (currentAudio) {
    stopSound();
  }
  
  // æ’­æ”¾æ–°éŸ³æ•ˆ
  playSound(sound);
}

// æ’­æ”¾éŸ³æ•ˆ
function playSound(sound) {
  try {
    currentAudio = new Audio(sound.url);
    currentAudio.loop = true;
    currentAudio.volume = ($('#volumeSlider')?.value || 50) / 100;
    
    currentAudio.play().then(() => {
      currentSoundId = sound.id;
      updateSoundUI();
      showToast(`æ­£åœ¨æ’­æ”¾: ${sound.name}`, 1500);
    }).catch(error => {
      console.error('æ’­æ”¾å¤±è´¥:', error);
      showToast('æ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 2000);
      currentAudio = null;
      currentSoundId = null;
    });
  } catch (error) {
    console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', error);
    showToast('éŸ³é¢‘åŠ è½½å¤±è´¥', 2000);
  }
}

// åœæ­¢éŸ³æ•ˆ
function stopSound() {
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
    currentAudio = null;
  }
  currentSoundId = null;
  updateSoundUI();
}

// æ›´æ–°UIçŠ¶æ€
function updateSoundUI() {
  document.querySelectorAll('.sound-item').forEach(item => {
    const soundId = item.dataset.soundId;
    if (soundId === currentSoundId) {
      item.classList.add('active');
    } else {
      item.classList.remove('active');
    }
  });
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  const soundBtn = $('#soundBtn');
  if (soundBtn) {
    if (currentSoundId) {
      soundBtn.style.color = 'var(--accent)';
    } else {
      soundBtn.style.color = '';
    }
  }
}

// åœ¨initå‡½æ•°ä¸­æ·»åŠ éŸ³æ•ˆé¢æ¿åˆå§‹åŒ–
// éœ€è¦åœ¨DOMContentLoadedåè°ƒç”¨
document.addEventListener('DOMContentLoaded', () => {
  initSoundPanel();
});

// ==================== ä¸“æ³¨ç©ºé—´åŠŸèƒ½ ====================
let focusTimer = null;
let focusTimeRemaining = 25 * 60; // é»˜è®¤25åˆ†é’Ÿï¼Œå•ä½ç§’
let focusTotalTime = 25 * 60;
let focusIsRunning = false;
let focusTasks = [];
let focusStats = {
  todayPomodoros: 0,
  todayFocusTime: 0, // åˆ†é’Ÿ
  lastDate: null
};

// ä¸“æ³¨è¯­å½•åº“
const focusQuotes = [
  "ä¸“æ³¨æ˜¯é€šå¾€å“è¶Šçš„å”¯ä¸€é“è·¯",
  "æ·±åº¦å·¥ä½œæ˜¯ä¸€ç§è¶…èƒ½åŠ›",
  "å¿ƒæµçŠ¶æ€ä¸‹ï¼Œæ—¶é—´ä¼šä¸ºä½ é©»è¶³",
  "ä¸“æ³¨çš„æ¯ä¸€åˆ†é’Ÿï¼Œéƒ½åœ¨å¡‘é€ æ›´å¥½çš„è‡ªå·±",
  "ä¸–ç•Œä¸Šæœ€å®è´µçš„èµ„æºï¼Œæ˜¯ä½ çš„æ³¨æ„åŠ›",
  "å½“ä½ ä¸“æ³¨æ—¶ï¼Œå…¨ä¸–ç•Œéƒ½ä¼šä¸ºä½ è®©è·¯",
  "æˆåŠŸçš„ç§˜è¯€åœ¨äºå¯¹ç›®æ ‡ä¿æŒæŒç»­çš„ä¸“æ³¨",
  "ä¸“æ³¨ä¸æ˜¯é€‰æ‹©åšä»€ä¹ˆï¼Œè€Œæ˜¯é€‰æ‹©ä¸åšä»€ä¹ˆ",
  "æ·±åº¦æ€è€ƒéœ€è¦ä¸è¢«æ‰“æ‰°çš„æ—¶é—´",
  "ä¸“æ³¨æ˜¯å¯¹æŠ—ç¢ç‰‡åŒ–æ—¶ä»£çš„æœ€ä½³æ­¦å™¨"
];

// åŠ è½½ä¸“æ³¨æ•°æ®
function loadFocusData() {
  try {
    // åŠ è½½ä»»åŠ¡
    const tasksData = localStorage.getItem('startpage.focusTasks');
    if (tasksData) {
      focusTasks = JSON.parse(tasksData);
    }
    
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    const statsData = localStorage.getItem('startpage.focusStats');
    if (statsData) {
      focusStats = JSON.parse(statsData);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©
      const today = new Date().toDateString();
      if (focusStats.lastDate !== today) {
        focusStats.todayPomodoros = 0;
        focusStats.todayFocusTime = 0;
        focusStats.lastDate = today;
        saveFocusStats();
      }
    } else {
      focusStats.lastDate = new Date().toDateString();
    }
  } catch (e) {
    console.warn('åŠ è½½ä¸“æ³¨æ•°æ®å¤±è´¥:', e);
  }
}

// ä¿å­˜ä¸“æ³¨ä»»åŠ¡
function saveFocusTasks() {
  localStorage.setItem('startpage.focusTasks', JSON.stringify(focusTasks));
}

// ä¿å­˜ä¸“æ³¨ç»Ÿè®¡
function saveFocusStats() {
  localStorage.setItem('startpage.focusStats', JSON.stringify(focusStats));
}

// æ‰“å¼€ä¸“æ³¨æ¨¡å¼
// æ‰“å¼€ä¸“æ³¨æ¨¡å¼
function openFocusMode() {
  loadFocusData();
  const focusMode = $('#focusMode');
  focusMode.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  // åº”ç”¨ä¿å­˜çš„é€æ˜åº¦
  const savedOpacity = localStorage.getItem('startpage.focusOpacity') || '85';
  updateFocusOpacity(savedOpacity);
  
  // æ˜¾ç¤ºéšæœºè¯­å½•
  const randomQuote = focusQuotes[Math.floor(Math.random() * focusQuotes.length)];
  $('#focusQuote').textContent = `"${randomQuote}"`;
  
  // æ¸²æŸ“ä»»åŠ¡å’Œç»Ÿè®¡
  renderFocusTasks();
  updateFocusStats();
  
  // é‡ç½®è®¡æ—¶å™¨æ˜¾ç¤º
  updateTimerDisplay();
}

// å…³é—­ä¸“æ³¨æ¨¡å¼
function exitFocusMode() {
  const focusMode = $('#focusMode');
  focusMode.classList.add('hidden');
  document.body.style.overflow = '';
  
  // åœæ­¢è®¡æ—¶å™¨
  if (focusIsRunning) {
    pauseFocusTimer();
  }
}

// å¼€å§‹ä¸“æ³¨è®¡æ—¶
function startFocusTimer() {
  if (focusIsRunning) return;
  
  focusIsRunning = true;
  $('#focusStartBtn').classList.add('hidden');
  $('#focusPauseBtn').classList.remove('hidden');
  $('#focusTimerLabel').textContent = 'ä¸“æ³¨ä¸­...';
  
  focusTimer = setInterval(() => {
    focusTimeRemaining--;
    updateTimerDisplay();
    updateProgressRing();
    
    if (focusTimeRemaining <= 0) {
      completeFocusSession();
    }
  }, 1000);
}

// æš‚åœä¸“æ³¨è®¡æ—¶
function pauseFocusTimer() {
  focusIsRunning = false;
  clearInterval(focusTimer);
  $('#focusStartBtn').classList.remove('hidden');
  $('#focusPauseBtn').classList.add('hidden');
  $('#focusTimerLabel').textContent = 'å·²æš‚åœ';
}

// é‡ç½®ä¸“æ³¨è®¡æ—¶
function resetFocusTimer() {
  pauseFocusTimer();
  focusTimeRemaining = focusTotalTime;
  updateTimerDisplay();
  updateProgressRing();
  $('#focusTimerLabel').textContent = 'å‡†å¤‡å¼€å§‹';
}

// å®Œæˆä¸“æ³¨ä¼šè¯
function completeFocusSession() {
  pauseFocusTimer();
  
  // æ›´æ–°ç»Ÿè®¡
  focusStats.todayPomodoros++;
  focusStats.todayFocusTime += Math.floor(focusTotalTime / 60);
  saveFocusStats();
  updateFocusStats();
  
  // æ˜¾ç¤ºå®Œæˆæç¤º
  $('#focusTimerLabel').textContent = 'å®Œæˆï¼';
  showToast(' å¤ªæ£’äº†ï¼å®Œæˆä¸€ä¸ªä¸“æ³¨å‘¨æœŸï¼');
  
  // æ’­æ”¾å®ŒæˆéŸ³æ•ˆï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
  try {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUKfk8LNlGwU7k9nyyXkqBSl+zfDcjkILEl+1 6eylVhQKR6Dh87tjHwUrgs3z2og1CBxqvvDmnE0MD1Cn5PCzZBoFPJTZ8sl4KgUngc/w2o0/CxFftejsp1QUCUig4fO7Y yEFK4PN89qINQgcab7w5p1MDA9RqOTws2MaBT2U2fLKdykFKX/P8NqNPwoQYLfn7KhUEwhJoeHzu2cgBSyDzvPaizUIHW3A8eadTQoPU6nl8LJkGgU+ltryynYpBSqA0PDajkALEGG46eynVBMISKLh87tmIAUsgs/z2Yk1CB1twPHmnU0KD1Oo5fCzYxoFPpbZ8sp1KQUqgNDw2o4/ChBiuOjsp1QTB0mi4PO7ZyAFLIPP89qJNQgdbsHx551NCg9Sp+Xws2MaBT+W2fLKdikFKoDQ8NqOPwoQYrjp7KdUEwdJo+Dzumg');
    audio.play();
  } catch (e) {}
  
  // 3ç§’åé‡ç½®
  setTimeout(() => {
    resetFocusTimer();
  }, 3000);
}

// æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
function updateTimerDisplay() {
  const minutes = Math.floor(focusTimeRemaining / 60);
  const seconds = focusTimeRemaining % 60;
  const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  $('#focusTimeDisplay').textContent = display;
}

// æ›´æ–°è¿›åº¦ç¯
function updateProgressRing() {
  const circle = document.querySelector('.progress-ring-circle');
  const circumference = 2 * Math.PI * 85; // 2Ï€r
  const progress = focusTimeRemaining / focusTotalTime;
  const offset = circumference * (1 - progress);
  circle.style.strokeDashoffset = offset;
}

// è®¾ç½®ä¸“æ³¨æ—¶é•¿
function setFocusDuration(minutes) {
  if (focusIsRunning) {
    showToast('è¯·å…ˆåœæ­¢å½“å‰è®¡æ—¶');
    return;
  }
  
  focusTotalTime = minutes * 60;
  focusTimeRemaining = focusTotalTime;
  updateTimerDisplay();
  updateProgressRing();
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  document.querySelectorAll('.duration-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
}

// æ¸²æŸ“ä¸“æ³¨ä»»åŠ¡åˆ—è¡¨
function renderFocusTasks() {
  const tasksList = $('#focusTasksList');
  if (!tasksList) return;
  
  if (focusTasks.length === 0) {
    tasksList.innerHTML = '<div style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px; font-size: 14px;">æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div>';
    return;
  }
  
  tasksList.innerHTML = focusTasks.map((task, index) => `
    <div class="focus-task-item">
      <div class="task-checkbox ${task.completed ? 'checked' : ''}" data-index="${index}"></div>
      <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
      <button class="task-delete" data-index="${index}">Ã—</button>
    </div>
  `).join('');
  
  // ç»‘å®šäº‹ä»¶
  tasksList.querySelectorAll('.task-checkbox').forEach(checkbox => {
    checkbox.addEventListener('click', (e) => {
      const index = parseInt(e.target.dataset.index);
      focusTasks[index].completed = !focusTasks[index].completed;
      saveFocusTasks();
      renderFocusTasks();
    });
  });
  
  tasksList.querySelectorAll('.task-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const index = parseInt(e.target.dataset.index);
      focusTasks.splice(index, 1);
      saveFocusTasks();
      renderFocusTasks();
    });
  });
}

// æ·»åŠ ä¸“æ³¨ä»»åŠ¡
function showAddTaskInput() {
  const input = $('#newFocusTaskInput');
  input.classList.remove('hidden');
  input.focus();
  
  input.onkeydown = (e) => {
    if (e.key === 'Enter') {
      const text = input.value.trim();
      if (text) {
        focusTasks.push({ text, completed: false });
        saveFocusTasks();
        renderFocusTasks();
      }
      input.value = '';
      input.classList.add('hidden');
    } else if (e.key === 'Escape') {
      input.value = '';
      input.classList.add('hidden');
    }
  };
  
  input.onblur = () => {
    setTimeout(() => {
      input.classList.add('hidden');
      input.value = '';
    }, 200);
  };
}

// æ›´æ–°ä¸“æ³¨ç»Ÿè®¡æ˜¾ç¤º
function updateFocusStats() {
  $('#todayPomodoroCount').textContent = focusStats.todayPomodoros;
  $('#todayFocusTime').textContent = `${focusStats.todayFocusTime}åˆ†é’Ÿ`;
}

// åˆå§‹åŒ–ä¸“æ³¨æ¨¡å¼äº‹ä»¶
function initFocusMode() {
  const focusBtn = $('#focusBtn');
  const exitFocusBtn = $('#exitFocusBtn');
  const focusStartBtn = $('#focusStartBtn');
  const focusPauseBtn = $('#focusPauseBtn');
  const focusResetBtn = $('#focusResetBtn');
  const addFocusTaskBtn = $('#addFocusTaskBtn');
  const opacitySlider = $('#focusOpacitySlider');
  const opacityValue = $('#focusOpacityValue');
  
  if (focusBtn) focusBtn.addEventListener('click', openFocusMode);
  if (exitFocusBtn) exitFocusBtn.addEventListener('click', exitFocusMode);
  if (focusStartBtn) focusStartBtn.addEventListener('click', startFocusTimer);
  if (focusPauseBtn) focusPauseBtn.addEventListener('click', pauseFocusTimer);
  if (focusResetBtn) focusResetBtn.addEventListener('click', resetFocusTimer);
  if (addFocusTaskBtn) addFocusTaskBtn.addEventListener('click', showAddTaskInput);
  
  // é€æ˜åº¦æ§åˆ¶
  if (opacitySlider && opacityValue) {
    // åŠ è½½ä¿å­˜çš„é€æ˜åº¦
    const savedOpacity = localStorage.getItem('startpage.focusOpacity') || '85';
    opacitySlider.value = savedOpacity;
    opacityValue.textContent = savedOpacity + '%';
    
    opacitySlider.addEventListener('input', (e) => {
      const opacity = e.target.value;
      opacityValue.textContent = opacity + '%';
      updateFocusOpacity(opacity);
    });
    
    opacitySlider.addEventListener('change', (e) => {
      // ä¿å­˜é€æ˜åº¦è®¾ç½®
      localStorage.setItem('startpage.focusOpacity', e.target.value);
    });
  }
  
  // æ—¶é•¿é€‰æ‹©æŒ‰é’®
  document.querySelectorAll('.duration-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const duration = parseInt(e.target.dataset.duration);
      setFocusDuration(duration);
    });
  });
  
  // å¿«æ·é”®æ”¯æŒ
  document.addEventListener('keydown', (e) => {
    const focusMode = $('#focusMode');
    if (focusMode.classList.contains('hidden')) return;
    
    if (e.key === 'Escape') {
      exitFocusMode();
    } else if (e.key === ' ' && e.target.tagName !== 'INPUT') {
      e.preventDefault();
      if (focusIsRunning) {
        pauseFocusTimer();
      } else {
        startFocusTimer();
      }
    } else if (e.key === 'r' || e.key === 'R') {
      resetFocusTimer();
    }
  });
}

// æ›´æ–°ä¸“æ³¨ç©ºé—´é€æ˜åº¦
function updateFocusOpacity(opacity) {
  const focusMode = $('#focusMode');
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const opacityValue = parseInt(opacity) / 100;
  
  if (isDark) {
    focusMode.style.background = `rgba(0, 0, 0, ${opacityValue})`;
  } else {
    focusMode.style.background = `rgba(255, 255, 255, ${opacityValue})`;
  }
}

// ==================== ç•Œé¢å¤–è§‚è®¾ç½® ====================
function initAppearanceSettings() {
  const appearanceDialog = document.getElementById('appearanceDialog');
  const cancelBtn = document.getElementById('cancelAppearanceBtn');
  const saveBtn = document.getElementById('saveAppearanceBtn');
  const resetBtn = document.getElementById('resetAppearanceBtn');
  
  if (!appearanceDialog) return;
  
  // é»˜è®¤è®¾ç½®
  const defaults = {
    clockSize: 48,
    clockTextOpacity: 100,
    clockBgOpacity: 80,
    clockColor: null,
    showClock: true,
    greetingSize: 16,
    greetingTextOpacity: 100,
    greetingBgOpacity: 80,
    greetingColor: null,
    showGreeting: true,
    quoteSize: 13,
    quoteTextOpacity: 85,
    quoteBgOpacity: 80,
    quoteColor: null,
    showQuote: true,
    searchSize: 100,
    searchBgOpacity: 72,
    showSearch: true,
    bookmarkColumns: 6,
    showBookmarks: true
  };
  
  // è·å–å½“å‰è®¾ç½® (åˆå¹¶é»˜è®¤å€¼ä»¥å¤„ç†æ–°å­—æ®µ)
  let saved = JSON.parse(localStorage.getItem('startpage.appearance') || '{}');
  let settings = { ...defaults, ...saved };
  
  // å…ƒç´ å¼•ç”¨
  const elements = {
    clock: document.getElementById('clock'),
    greeting: document.getElementById('greeting'),
    quote: document.getElementById('quote'),
    quoteText: document.getElementById('quoteText'),
    quoteAuthor: document.getElementById('quoteAuthor'),
    searchInput: document.querySelector('.search input'),
    searchContainer: document.querySelector('.search-container'),
    linksGrid: document.getElementById('linksGrid')
  };
  
  // æ»‘å—å¼•ç”¨
  const sliders = {
    clockSize: document.getElementById('clockSizeSlider'),
    clockTextOpacity: document.getElementById('clockTextOpacitySlider'),
    clockBgOpacity: document.getElementById('clockBgOpacitySlider'),
    greetingSize: document.getElementById('greetingSizeSlider'),
    greetingTextOpacity: document.getElementById('greetingTextOpacitySlider'),
    greetingBgOpacity: document.getElementById('greetingBgOpacitySlider'),
    quoteSize: document.getElementById('quoteSizeSlider'),
    quoteTextOpacity: document.getElementById('quoteTextOpacitySlider'),
    quoteBgOpacity: document.getElementById('quoteBgOpacitySlider'),
    searchSize: document.getElementById('searchSizeSlider'),
    searchBgOpacity: document.getElementById('searchBgOpacitySlider'),
    bookmarkColumns: document.getElementById('bookmarkColumnsSlider')
  };

  // å¤é€‰æ¡†å¼•ç”¨
  const checkboxes = {
    showClock: document.getElementById('showClockCheck'),
    showGreeting: document.getElementById('showGreetingCheck'),
    showQuote: document.getElementById('showQuoteCheck'),
    showSearch: document.getElementById('showSearchCheck'),
    showBookmarks: document.getElementById('showBookmarksCheck')
  };
  
  // å€¼æ˜¾ç¤ºå¼•ç”¨
  const values = {
    clockSize: document.getElementById('clockSizeValue'),
    clockTextOpacity: document.getElementById('clockTextOpacityValue'),
    clockBgOpacity: document.getElementById('clockBgOpacityValue'),
    greetingSize: document.getElementById('greetingSizeValue'),
    greetingTextOpacity: document.getElementById('greetingTextOpacityValue'),
    greetingBgOpacity: document.getElementById('greetingBgOpacityValue'),
    quoteSize: document.getElementById('quoteSizeValue'),
    quoteTextOpacity: document.getElementById('quoteTextOpacityValue'),
    quoteBgOpacity: document.getElementById('quoteBgOpacityValue'),
    searchSize: document.getElementById('searchSizeValue'),
    searchBgOpacity: document.getElementById('searchBgOpacityValue'),
    bookmarkColumns: document.getElementById('bookmarkColumnsValue')
  };
  
  // åº”ç”¨è®¾ç½®åˆ°DOM
  function applySettings(newSettings) {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const baseColor = isDark ? '28, 28, 30' : '255, 255, 255';
    
    // å¯è§æ€§æ§åˆ¶
    if (elements.clock) elements.clock.style.display = newSettings.showClock ? '' : 'none';
    if (elements.greeting) elements.greeting.style.display = newSettings.showGreeting ? '' : 'none';
    if (elements.quote) elements.quote.style.display = newSettings.showQuote ? '' : 'none';
    if (elements.searchContainer) elements.searchContainer.style.display = newSettings.showSearch ? '' : 'none';
    if (elements.linksGrid) {
        if (newSettings.showBookmarks) {
            elements.linksGrid.style.removeProperty('display');
        } else {
            elements.linksGrid.style.setProperty('display', 'none', 'important');
        }
    }

    // æ—¶é’Ÿ
    if (elements.clock) {
      elements.clock.style.fontSize = `${newSettings.clockSize}px`;
      // æ–‡å­—é€æ˜åº¦ & é¢œè‰²
      const textColor = newSettings.clockColor || 'var(--text)';
      elements.clock.style.color = `color-mix(in srgb, ${textColor}, transparent ${100 - newSettings.clockTextOpacity}%)`;
      // èƒŒæ™¯é€æ˜åº¦
      elements.clock.style.background = `linear-gradient(135deg, rgba(${baseColor}, ${newSettings.clockBgOpacity/100}) 0%, rgba(255,255,255, 0.05) 100%)`;
      // ç§»é™¤æ—§çš„ opacity è®¾ç½®
      elements.clock.style.opacity = '';
    }
    
    // é—®å€™è¯­
    if (elements.greeting) {
      elements.greeting.style.fontSize = `${newSettings.greetingSize}px`;
      const textColor = newSettings.greetingColor || 'var(--text)';
      elements.greeting.style.color = `color-mix(in srgb, ${textColor}, transparent ${100 - newSettings.greetingTextOpacity}%)`;
      elements.greeting.style.background = `linear-gradient(135deg, rgba(${baseColor}, ${newSettings.greetingBgOpacity/100}) 0%, rgba(255,255,255, 0.05) 100%)`;
      elements.greeting.style.opacity = '';
    }
    
    // æ¯æ—¥ä¸€è¨€
    if (elements.quote) {
      elements.quote.style.background = `linear-gradient(135deg, rgba(${baseColor}, ${newSettings.quoteBgOpacity/100}) 0%, rgba(255,255,255, 0.05) 100%)`;
      elements.quote.style.opacity = '';
      // æ–‡å­—é¢œè‰²åº”ç”¨åˆ°å†…éƒ¨æ–‡æœ¬
      if (elements.quoteText) {
         const textColor = newSettings.quoteColor || 'var(--text)';
         elements.quoteText.style.color = `color-mix(in srgb, ${textColor}, transparent ${100 - newSettings.quoteTextOpacity}%)`;
         elements.quoteText.style.fontSize = `${newSettings.quoteSize}px`;
      }
      if (elements.quoteAuthor) {
         const textColor = newSettings.quoteColor ? newSettings.quoteColor : 'var(--muted)';
         elements.quoteAuthor.style.color = `color-mix(in srgb, ${textColor}, transparent ${100 - newSettings.quoteTextOpacity}%)`;
         elements.quoteAuthor.style.fontSize = `${Math.max(10, newSettings.quoteSize - 2)}px`;
      }
    }
    
    // æœç´¢æ¡†
    if (elements.searchContainer) {
        elements.searchContainer.style.transform = `scale(${newSettings.searchSize / 100})`;
        // ä¿æŒå±…ä¸­
        elements.searchContainer.style.transformOrigin = 'center top';
    }
    if (elements.searchInput) {
        elements.searchInput.style.backgroundColor = `rgba(${baseColor}, ${newSettings.searchBgOpacity / 100})`;
    }

    // æ¡Œé¢ä¹¦ç­¾åˆ—æ•°
    if (elements.linksGrid) {
      // åªæœ‰åœ¨æ¡Œé¢ä¹¦ç­¾æ¨¡å¼ä¸‹æ‰ç”Ÿæ•ˆ
      elements.linksGrid.style.gridTemplateColumns = `repeat(${newSettings.bookmarkColumns}, 1fr)`;
    }
  }
  
  // é¢œè‰²è¾“å…¥å¼•ç”¨
  const colorInputs = {
    clockColor: document.getElementById('clockColorInput'),
    greetingColor: document.getElementById('greetingColorInput'),
    quoteColor: document.getElementById('quoteColorInput')
  };

  const resetColorBtns = {
    clockColor: document.getElementById('resetClockColorBtn'),
    greetingColor: document.getElementById('resetGreetingColorBtn'),
    quoteColor: document.getElementById('resetQuoteColorBtn')
  };

  // æ›´æ–°æ»‘å—å’Œæ˜¾ç¤ºå€¼
  function updateControls() {
    Object.keys(sliders).forEach(key => {
      if (sliders[key] && values[key]) {
        // ç¡®ä¿ settings ä¸­æœ‰è¯¥å€¼ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤
        const val = settings[key] !== undefined ? settings[key] : defaults[key];
        sliders[key].value = val;
        
        if (key.includes('Opacity') || key.includes('searchSize')) {
          values[key].textContent = `${val}%`;
        } else {
          values[key].textContent = val;
        }
      }
    });
    
    // æ›´æ–°é¢œè‰²è¾“å…¥
    Object.keys(colorInputs).forEach(key => {
      if (colorInputs[key]) {
        const val = settings[key] || '#ffffff'; // é»˜è®¤æ˜¾ç¤ºç™½è‰²ï¼Œå¦‚æœæœªè®¾ç½®
        colorInputs[key].value = val;
      }
    });

    // æ›´æ–°å¤é€‰æ¡†
    Object.keys(checkboxes).forEach(key => {
      if (checkboxes[key]) {
        checkboxes[key].checked = settings[key] !== undefined ? settings[key] : defaults[key];
      }
    });
  }
  
  // ç›‘å¬ä¸»é¢˜å˜åŒ–
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
        applySettings(settings);
      }
    });
  });
  observer.observe(document.documentElement, { attributes: true });
  
  // åˆå§‹åŒ–
  applySettings(settings);
  updateControls();
  
  // ç»‘å®šæ»‘å—äº‹ä»¶
  Object.keys(sliders).forEach(key => {
    if (sliders[key]) {
      sliders[key].addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        settings[key] = value;
        
        if (key.includes('Opacity') || key.includes('searchSize')) {
          values[key].textContent = `${value}%`;
        } else {
          values[key].textContent = value;
        }
        
        applySettings(settings);
      });
    }
  });

  // ç»‘å®šé¢œè‰²äº‹ä»¶
  Object.keys(colorInputs).forEach(key => {
    if (colorInputs[key]) {
      colorInputs[key].addEventListener('input', (e) => {
        settings[key] = e.target.value;
        applySettings(settings);
      });
    }
  });

  // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
  Object.keys(checkboxes).forEach(key => {
    if (checkboxes[key]) {
      checkboxes[key].addEventListener('change', (e) => {
        settings[key] = e.target.checked;
        applySettings(settings);
      });
    }
  });

  Object.keys(resetColorBtns).forEach(key => {
    if (resetColorBtns[key]) {
      resetColorBtns[key].addEventListener('click', () => {
        settings[key] = null;
        applySettings(settings);
        // é‡ç½®è¾“å…¥æ¡†é¢œè‰²
        if (colorInputs[key]) colorInputs[key].value = '#ffffff';
      });
    }
  });
  
  // æŒ‰é’®äº‹ä»¶
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
      // æ¢å¤åˆ°ä¿å­˜çš„è®¾ç½®
      saved = JSON.parse(localStorage.getItem('startpage.appearance') || '{}');
      settings = { ...defaults, ...saved };
      applySettings(settings);
      updateControls();
      appearanceDialog.close();
    });
  }
  
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      localStorage.setItem('startpage.appearance', JSON.stringify(settings));
      appearanceDialog.close();
      showToast('è®¾ç½®å·²ä¿å­˜');
    });
  }
  
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      settings = JSON.parse(JSON.stringify(defaults));
      applySettings(settings);
      updateControls();
    });
  }
}

// åœ¨DOMContentLoadedååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  loadSearchEngines();  // åŠ è½½æœç´¢å¼•æ“é…ç½®
  initFocusMode();
  initAppearanceSettings(); // åˆå§‹åŒ–å¤–è§‚è®¾ç½®
  
  // ç»‘å®šä¹¦ç­¾åˆ—è¡¨äº‹ä»¶å§”æ‰˜
  const bookmarksList = document.getElementById('bookmarksList');
  if (bookmarksList) {
    bookmarksList.addEventListener('click', handleBookmarkActions, true);
  }
});